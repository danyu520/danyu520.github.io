<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§è™šæ‹Ÿè´§å¸äº¤æ˜“æ¨¡æ‹Ÿç³»ç»Ÿ - å¢å¼ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        :root {
            --up-color: #f44336;
            --down-color: #4CAF50;
            --primary-color: #2196F3;
            --warning-color: #FF9800;
            --special-color: #9C27B0;
            --rescue-color: #FF5722;
            --dark-color: #333;
            --light-color: #f5f5f5;
            --success-color: #8BC34A;
            --info-color: #00BCD4;
        }
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .price-display {
            font-size: 28px;
            font-weight: bold;
        }
        .price-change {
            margin-left: 10px;
            font-size: 18px;
        }
        .up { color: var(--up-color); }
        .down { color: var(--down-color); }
        .market-data {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .data-item {
            text-align: center;
        }
        .data-value {
            font-size: 18px;
            font-weight: bold;
        }
        .data-label {
            font-size: 12px;
            color: #666;
        }
        .btn {
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        .btn-up { background-color: var(--up-color); }
        .btn-down { background-color: var(--down-color); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-warning { background-color: var(--warning-color); }
        .btn-special { background-color: var(--special-color); }
        .btn-rescue { background-color: var(--rescue-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-info { background-color: var(--info-color); }
        .btn-group {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
        }
        .scenario-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .trade-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .trade-panel {
            padding: 15px;
            border-radius: 8px;
        }
        #buyPanel { background-color: rgba(76, 175, 80, 0.1); }
        #sellPanel { background-color: rgba(244, 67, 54, 0.1); }
        .chart-container {
            height: 400px;
            margin-top: 20px;
        }
        .auto-controls {
            display: flex;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .auto-controls label {
            margin-right: 10px;
            margin-bottom: 0;
        }
        #autoInterval {
            width: 60px;
            margin-right: 10px;
        }
        .user-balance {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .balance-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .transaction-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .transaction-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        .transaction-buy { color: var(--down-color); }
        .transaction-sell { color: var(--up-color); }
        .tab-container {
            display: flex;
            margin-bottom: 15px;
            overflow-x: auto;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .advanced-scenario {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .leverage-controls {
            background-color: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .order-book {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .order-side {
            display: flex;
            flex-direction: column;
        }
        .order-row {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .order-row.bid {
            background-color: rgba(76, 175, 80, 0.1);
        }
        .order-row.ask {
            background-color: rgba(244, 67, 54, 0.1);
        }
        .depth-chart-container {
            height: 200px;
            margin-top: 15px;
        }
        .news-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 4px;
        }
        .news-time {
            font-size: 12px;
            color: #666;
        }
        .news-content {
            margin-top: 5px;
        }
        .news-positive {
            border-left: 3px solid var(--down-color);
        }
        .news-negative {
            border-left: 3px solid var(--up-color);
        }
        .news-neutral {
            border-left: 3px solid var(--primary-color);
        }
        .portfolio-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .portfolio-profit {
            font-weight: bold;
        }
        .profit-positive {
            color: var(--down-color);
        }
        .profit-negative {
            color: var(--up-color);
        }
        .strategy-controls {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .social-sentiment {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .sentiment-bar {
            flex-grow: 1;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 10px;
        }
        .sentiment-fill {
            height: 100%;
            width: 50%;
            background-color: var(--down-color);
        }
        .sentiment-value {
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        .market-depth {
            margin-top: 15px;
        }
        .market-maker-controls {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .derivatives-panel {
            background-color: #f3e5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .dark-mode {
            background-color: #121212;
            color: #ffffff;
        }
        .dark-mode .panel,
        .dark-mode .user-balance,
        .dark-mode .news-item {
            background-color: #1e1e1e;
            color: #ffffff;
        }
        .dark-mode .data-label {
            color: #aaaaaa;
        }
        .dark-mode input,
        .dark-mode select {
            background-color: #2d2d2d;
            color: #ffffff;
            border-color: #444;
        }
        .dark-mode .advanced-scenario {
            background-color: #252525;
        }
        .dark-mode .leverage-controls {
            background-color: #332c1e;
        }
        .dark-mode .strategy-controls {
            background-color: #1e2a1e;
        }
        .dark-mode .market-maker-controls {
            background-color: #1e252e;
        }
        .dark-mode .derivatives-panel {
            background-color: #2a1e2e;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .dark-mode .tooltip .tooltiptext {
            background-color: #333;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        .notification.error {
            background-color: #f44336;
        }
        .notification.warning {
            background-color: #FF9800;
        }
        .notification.info {
            background-color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="dark-mode-toggle">
        <button id="darkModeToggle" class="btn btn-special">ğŸŒ“ æš—é»‘æ¨¡å¼</button>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <div class="header">
        <h1>é«˜çº§è™šæ‹Ÿè´§å¸äº¤æ˜“æ¨¡æ‹Ÿç³»ç»Ÿ - å¢å¼ºç‰ˆ</h1>
        <p>æ¨¡æ‹ŸçœŸå®å¸‚åœºè¡Œä¸º - æ”¯æŒå¤šç§äº¤æ˜“ç­–ç•¥å’Œå¸‚åœºæƒ…æ™¯</p>
    </div>
    
    <div class="dashboard">
        <div class="panel">
            <h2>å¸‚åœºè¡Œæƒ…</h2>
            <div class="price-display">
                1 æ³¢åŠ¨å¸ = <span id="current-price">1</span> å…ƒ
                <span class="price-change up" id="price-change">+0.32 (6.4%)</span>
            </div>
            <div class="market-data">
                <div class="data-item">
                    <div class="data-value" id="market-cap">10</div>
                    <div class="data-label">å¸‚å€¼(å…ƒ)</div>
                </div>
                <div class="data-item">
                    <div class="data-value" id="volume">0</div>
                    <div class="data-label">24hæˆäº¤é‡</div>
                </div>
                <div class="data-item">
                    <div class="data-value" id="high-price">0</div>
                    <div class="data-label">24hæœ€é«˜</div>
                </div>
                <div class="data-item">
                    <div class="data-value" id="low-price">0</div>
                    <div class="data-label">24hæœ€ä½</div>
                </div>
            </div>
            
            <div class="social-sentiment">
                <span>å¸‚åœºæƒ…ç»ª:</span>
                <div class="sentiment-bar">
                    <div class="sentiment-fill" id="sentiment-fill"></div>
                </div>
                <span class="sentiment-value" id="sentiment-value">50%</span>
            </div>
            
            <div class="auto-controls">
                <label for="autoInterval">è‡ªåŠ¨é—´éš”(ç§’):</label>
                <input type="number" id="autoInterval" min="1" value="10">
                <button id="toggleAuto" class="btn btn-primary">å¯åŠ¨è‡ªåŠ¨æ³¢åŠ¨</button>
                <select id="autoMode" class="btn">
                    <option value="random">éšæœºæ¨¡å¼</option>
                    <option value="sideways">æ¨ªç›˜éœ‡è¡</option>
                    <option value="volatile">å‰§çƒˆæ³¢åŠ¨</option>
                    <option value="trend">è¶‹åŠ¿æ¨¡å¼</option>
                    <option value="cycle">å‘¨æœŸå¾ªç¯</option>
                    <option value="pump-dump">æ‹‰ç›˜ç ¸ç›˜</option>
                    <option value="whale">é²¸é±¼æ“çºµ</option>
                    <option value="rollercoaster">è·Œå®•èµ·ä¼</option>
                    <option value="market-maker">åšå¸‚å•†æ¨¡å¼</option>
                </select>
            </div>
        </div>
        
        <div class="user-balance">
            <h2>æˆ‘çš„èµ„äº§</h2>
            <div class="balance-item">
                <span>ç°é‡‘ä½™é¢:</span>
                <span id="cash-balance">100,000.00 å…ƒ</span>
            </div>
            <div class="balance-item">
                <span>æ³¢åŠ¨å¸æŒä»“:</span>
                <span id="coin-balance">0.00 æ³¢åŠ¨å¸</span>
            </div>
            <div class="balance-item">
                <span>åˆçº¦æŒä»“:</span>
                <span id="contract-balance">0 å¼ </span>
            </div>
            <div class="balance-item">
                <span>æ€»èµ„äº§ä»·å€¼:</span>
                <span id="total-assets">100,000.00 å…ƒ</span>
            </div>
            <div class="balance-item">
                <span>æ æ†å€æ•°:</span>
                <span id="leverage">1Ã—</span>
            </div>
            <div class="balance-item">
                <span>ä»Šæ—¥ç›ˆäº:</span>
                <span id="daily-pnl" class="profit-neutral">0.00 å…ƒ (0.00%)</span>
            </div>
        </div>
    </div>
    
    <div class="panel">
        <div class="tab-container">
            <div class="tab active" data-tab="scenarios">å¸‚åœºæƒ…æ™¯</div>
            <div class="tab" data-tab="technical">æŠ€æœ¯åˆ†æ</div>
            <div class="tab" data-tab="advanced">é«˜çº§æ¨¡æ‹Ÿ</div>
            <div class="tab" data-tab="leverage">æ æ†äº¤æ˜“</div>
            <div class="tab" data-tab="orderbook">è®¢å•ç°¿</div>
            <div class="tab" data-tab="portfolio">æŠ•èµ„ç»„åˆ</div>
            <div class="tab" data-tab="strategies">äº¤æ˜“ç­–ç•¥</div>
            <div class="tab" data-tab="news">å¸‚åœºæ–°é—»</div>
            <div class="tab" data-tab="derivatives">è¡ç”Ÿå“</div>
        </div>
        
        <div class="tab-content active" id="scenarios-tab">
            <div class="scenario-title">åŸºæœ¬æ³¢åŠ¨</div>
            <div class="btn-group">
                <button class="btn btn-up" id="small-up">å°å¹…ä¸Šæ¶¨ (+2%)</button>
                <button class="btn btn-down" id="small-down">å°å¹…ä¸‹è·Œ (-2%)</button>
                <button class="btn btn-primary" id="random-normal">éšæœºæ³¢åŠ¨ (Â±5%)</button>
                <button class="btn btn-up" id="medium-up">æ¸©å’Œä¸Šæ¶¨ (+8%)</button>
                <button class="btn btn-down" id="medium-down">æ¸©å’Œä¸‹è·Œ (-8%)</button>
            </div>
            
            <div class="scenario-title">æç«¯è¡Œæƒ…</div>
            <div class="btn-group">
                <button class="btn btn-up" id="large-up">å¤§å¹…ä¸Šæ¶¨ (+20%)</button>
                <button class="btn btn-down" id="large-down">å¤§å¹…ä¸‹è·Œ (-20%)</button>
                <button class="btn btn-warning" id="flash-crash">é—ªå´© (-50%)</button>
                <button class="btn btn-warning" id="moon-shot">ç«ç®­å‘å°„ (+100%)</button>
                <button class="btn btn-special" id="bubble-burst">æ³¡æ²«ç ´è£‚ (-70%)</button>
                <button class="btn btn-warning" id="dead-cat-bounce">æ­»çŒ«åå¼¹ (+30%å-50%)</button>
            </div>
            
            <div class="scenario-title">å¸‚åœºå½¢æ€</div>
            <div class="btn-group">
                <button class="btn btn-primary" id="sideways">æ¨ªç›˜éœ‡è¡ (Â±1%)</button>
                <button class="btn btn-primary" id="volatile">å‰§çƒˆæ³¢åŠ¨ (Â±15%)</button>
                <button class="btn btn-primary" id="trend-up">ä¸Šå‡è¶‹åŠ¿ (+ç³»åˆ—)</button>
                <button class="btn btn-primary" id="trend-down">ä¸‹é™è¶‹åŠ¿ (-ç³»åˆ—)</button>
                <button class="btn btn-special" id="support-test">æµ‹è¯•æ”¯æ’‘ä½</button>
                <button class="btn btn-special" id="resistance-test">æµ‹è¯•é˜»åŠ›ä½</button>
                <button class="btn btn-special" id="rollercoaster-btn">è·Œå®•èµ·ä¼æ¨¡å¼</button>
                <button class="btn btn-special" id="head-shoulders">å¤´è‚©é¡¶å½¢æ€</button>
                <button class="btn btn-special" id="double-bottom">åŒåº•å½¢æ€</button>
            </div>
            
            <div class="scenario-title">ç³»ç»Ÿæ“ä½œ</div>
            <div class="btn-group">
                <button class="btn" id="reset-price">é‡ç½®ä»·æ ¼ (5.00å…ƒ)</button>
                <button class="btn" id="reset-history">é‡ç½®å†å²æ•°æ®</button>
                <button class="btn" id="add-liquidity">å¢åŠ å¸‚åœºæµåŠ¨æ€§</button>
                <button class="btn" id="panic-sell">å¸‚åœºææ…ŒæŠ›å”®</button>
                <button class="btn" id="market-maker-btn">åšå¸‚å•†å¹²é¢„</button>
                <button class="btn" id="reset-balance">é‡ç½®æˆ‘çš„èµ„äº§</button>
            </div>
        </div>
        
        <div class="tab-content" id="technical-tab">
            <p>æŠ€æœ¯æŒ‡æ ‡åˆ†æé¢æ¿ (æ¨¡æ‹Ÿ)</p>
            <div class="btn-group">
                <button class="btn" id="show-ma">æ˜¾ç¤ºå‡çº¿</button>
                <button class="btn" id="show-macd">æ˜¾ç¤ºMACD</button>
                <button class="btn" id="show-rsi">æ˜¾ç¤ºRSI</button>
                <button class="btn" id="show-bollinger">æ˜¾ç¤ºå¸ƒæ—å¸¦</button>
                <button class="btn" id="show-fibonacci">æ˜¾ç¤ºæ–æ³¢é‚£å¥‘</button>
                <button class="btn" id="show-ichimoku">æ˜¾ç¤ºä¸€ç›®å‡è¡¡</button>
                <button class="btn" id="show-volume">æ˜¾ç¤ºæˆäº¤é‡</button>
            </div>
            <div id="indicator-display" style="height: 200px; background-color: #f9f9f9; display: flex; align-items: center; justify-content: center; margin-top: 15px; border-radius: 4px;">
                <p>é€‰æ‹©æŠ€æœ¯æŒ‡æ ‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label for="indicator-params">æŒ‡æ ‡å‚æ•°è®¾ç½®</label>
                <input type="text" id="indicator-params" placeholder="ä¾‹å¦‚: MAå‘¨æœŸ=5,10,30">
                <button id="apply-indicator" class="btn btn-primary" style="margin-top: 10px;">åº”ç”¨æŒ‡æ ‡è®¾ç½®</button>
            </div>
            
            <div class="scenario-title">è‡ªå®šä¹‰æŒ‡æ ‡</div>
            <div class="btn-group">
                <button class="btn btn-info" id="custom-indicator">åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡</button>
                <button class="btn btn-info" id="backtest-indicator">å›æµ‹æŒ‡æ ‡</button>
            </div>
        </div>
        
        <div class="tab-content" id="advanced-tab">
            <div class="advanced-scenario">
                <h3>é«˜çº§å¸‚åœºæ¨¡æ‹Ÿ</h3>
                <p>è¿™äº›æƒ…æ™¯æ¨¡æ‹Ÿæ›´å¤æ‚çš„å¸‚åœºè¡Œä¸º</p>
                
                <div class="scenario-title">å¸‚åœºæ“çºµ</div>
                <div class="btn-group">
                    <button class="btn btn-warning" id="pump-action">æ‹‰ç›˜è¡ŒåŠ¨ (+30%)</button>
                    <button class="btn btn-warning" id="dump-action">ç ¸ç›˜è¡ŒåŠ¨ (-40%)</button>
                    <button class="btn btn-special" id="whale-buy">é²¸é±¼ä¹°å…¥ (å¤§å•)</button>
                    <button class="btn btn-special" id="whale-sell">é²¸é±¼å–å‡º (å¤§å•)</button>
                    <button class="btn btn-special" id="spoofing">è™šå‡æŒ‚å• (è¯±éª—)</button>
                    <button class="btn btn-special" id="wash-trade">æ´—ç›˜äº¤æ˜“</button>
                </div>
                
                <div class="scenario-title">å¸‚åœºäº‹ä»¶</div>
                <div class="btn-group">
                    <button class="btn" id="good-news">åˆ©å¥½æ¶ˆæ¯ (+15%)</button>
                    <button class="btn" id="bad-news">åˆ©ç©ºæ¶ˆæ¯ (-18%)</button>
                    <button class="btn" id="exchange-hack">äº¤æ˜“æ‰€è¢«ç›— (-25%)</button>
                    <button class="btn" id="regulatory">ç›‘ç®¡æ¶ˆæ¯ (Â±20%)</button>
                    <button class="btn" id="fork-event">åˆ†å‰äº‹ä»¶ (Â±30%)</button>
                    <button class="btn" id="halving-event">å‡åŠäº‹ä»¶ (+50%)</button>
                    <button class="btn" id="airdrop">ç©ºæŠ•æ´»åŠ¨ (+15%)</button>
                </div>
                
                <div class="scenario-title">å¸‚åœºå‘¨æœŸ</div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="bull-market">ç‰›å¸‚å‘¨æœŸ</button>
                    <button class="btn btn-primary" id="bear-market">ç†Šå¸‚å‘¨æœŸ</button>
                    <button class="btn btn-primary" id="accumulation">å¸ç­¹é˜¶æ®µ</button>
                    <button class="btn btn-primary" id="distribution">æ´¾å‘é˜¶æ®µ</button>
                    <button class="btn btn-primary" id="seasonal-effect">å­£èŠ‚æ€§æ•ˆåº”</button>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label for="custom-change">è‡ªå®šä¹‰ä»·æ ¼å˜åŒ– (%)</label>
                    <input type="number" id="custom-change" step="0.1" placeholder="è¾“å…¥ç™¾åˆ†æ¯”å˜åŒ–">
                    <button id="apply-custom" class="btn" style="margin-top: 10px;">åº”ç”¨è‡ªå®šä¹‰å˜åŒ–</button>
                </div>
                
                <div class="market-maker-controls">
                    <h4>åšå¸‚å•†æ§åˆ¶</h4>
                    <div class="form-group">
                        <label for="maker-spread">ä¹°å–ä»·å·® (%)</label>
                        <input type="range" id="maker-spread" min="0.1" max="5" step="0.1" value="1">
                        <span id="maker-spread-value">1%</span>
                    </div>
                    <div class="form-group">
                        <label for="maker-volume">åšå¸‚é‡ (å¸)</label>
                        <input type="number" id="maker-volume" min="10" max="10000" value="100">
                    </div>
                    <button id="activate-maker" class="btn btn-info">æ¿€æ´»åšå¸‚å•†</button>
                    <button id="stop-maker" class="btn btn-warning">åœæ­¢åšå¸‚</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="leverage-tab">
            <div class="leverage-controls">
                <h3>æ æ†äº¤æ˜“ç³»ç»Ÿ</h3>
                <p>é€šè¿‡æ æ†æ”¾å¤§æ‚¨çš„äº¤æ˜“èƒ½åŠ›ï¼Œä½†è¯·æ³¨æ„é£é™©</p>
                
                <div class="form-group">
                    <label for="leverage-amount">è®¾ç½®æ æ†å€æ•° (1-100å€)</label>
                    <input type="range" id="leverage-amount" min="1" max="100" step="1" value="1">
                    <span id="leverage-display">1Ã—</span>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-rescue" id="leverage-buy">æ æ†ä¹°å…¥</button>
                    <button class="btn btn-rescue" id="leverage-sell">æ æ†å–å‡º</button>
                    <button class="btn" id="stop-out">æ¨¡æ‹Ÿå¼ºåˆ¶å¹³ä»“</button>
                    <button class="btn" id="hedge-position">å¯¹å†²æŒä»“</button>
                </div>
                
                <div class="scenario-title">æ•‘å¸‚æªæ–½</div>
                <div class="btn-group">
                    <button class="btn btn-rescue" id="market-rescue">æ”¿åºœæ•‘å¸‚ (+25%)</button>
                    <button class="btn btn-rescue" id="institutional-buy">æœºæ„æŠ¤ç›˜ (+15%)</button>
                    <button class="btn btn-rescue" id="circuit-breaker">ç†”æ–­æœºåˆ¶ (æš‚åœäº¤æ˜“)</button>
                    <button class="btn btn-rescue" id="liquidity-injection">æµåŠ¨æ€§æ³¨å…¥</button>
                </div>
                
                <div id="leverage-info" style="margin-top: 15px; padding: 10px; background-color: #e3f2fd; border-radius: 4px;">
                    <p><strong>æ æ†äº¤æ˜“è¯´æ˜ï¼š</strong></p>
                    <ul>
                        <li>æ æ†ä¼šæ”¾å¤§æ‚¨çš„æ”¶ç›Šå’ŒäºæŸ</li>
                        <li>å½“äºæŸè¾¾åˆ°ä¿è¯é‡‘çš„80%æ—¶å°†è§¦å‘å¼ºåˆ¶å¹³ä»“</li>
                        <li>é«˜æ æ†(5å€ä»¥ä¸Š)åœ¨å‰§çƒˆæ³¢åŠ¨å¸‚åœºé£é™©æé«˜</li>
                        <li>100å€æ æ†ä»…ç”¨äºæ¨¡æ‹Ÿæç«¯æƒ…å†µ</li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label for="position-size">ä»“ä½å¤§å° (%)</label>
                    <input type="range" id="position-size" min="1" max="100" value="10">
                    <span id="position-size-value">10%</span>
                </div>
                
                <div class="form-group">
                    <label for="stop-loss">æ­¢æŸè®¾ç½® (%)</label>
                    <input type="number" id="stop-loss" min="0" max="100" value="5">
                </div>
                
                <div class="form-group">
                    <label for="take-profit">æ­¢ç›ˆè®¾ç½® (%)</label>
                    <input type="number" id="take-profit" min="0" max="100" value="10">
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="orderbook-tab">
            <h3>è®¢å•ç°¿æ·±åº¦</h3>
            <div class="order-book">
                <div class="order-side">
                    <h4>ä¹°å• (Bids)</h4>
                    <div id="bid-orders">
                        <!-- ä¹°å•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="order-side">
                    <h4>å–å• (Asks)</h4>
                    <div id="ask-orders">
                        <!-- å–å•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <div class="market-depth">
                <h4>å¸‚åœºæ·±åº¦å›¾</h4>
                <div class="depth-chart-container">
                    <canvas id="depthChart"></canvas>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label for="place-order-type">è®¢å•ç±»å‹</label>
                <select id="place-order-type" class="btn">
                    <option value="limit">é™ä»·å•</option>
                    <option value="market">å¸‚ä»·å•</option>
                    <option value="stop">æ­¢æŸå•</option>
                    <option value="stop-limit">æ­¢æŸé™ä»·å•</option>
                    <option value="iceberg">å†°å±±è®¢å•</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="place-order-side">ä¹°å–æ–¹å‘</label>
                <select id="place-order-side" class="btn">
                    <option value="buy">ä¹°å…¥</option>
                    <option value="sell">å–å‡º</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="place-order-amount">æ•°é‡</label>
                <input type="number" id="place-order-amount" min="0.01" step="0.01" value="1">
            </div>
            
            <div class="form-group" id="price-group">
                <label for="place-order-price">ä»·æ ¼</label>
                <input type="number" id="place-order-price" min="0.0001" step="0.0001" value="5.00">
            </div>
            
            <div class="form-group" id="stop-price-group" style="display: none;">
                <label for="place-order-stop-price">è§¦å‘ä»·æ ¼</label>
                <input type="number" id="place-order-stop-price" min="0.0001" step="0.0001" value="5.00">
            </div>
            
            <button id="place-order-btn" class="btn btn-primary">æäº¤è®¢å•</button>
            <button id="cancel-all-orders" class="btn btn-warning">æ’¤é”€æ‰€æœ‰è®¢å•</button>
        </div>
        
        <div class="tab-content" id="portfolio-tab">
            <h3>æˆ‘çš„æŠ•èµ„ç»„åˆ</h3>
            <div class="portfolio-item">
                <span>åˆå§‹èµ„é‡‘:</span>
                <span>100,000.00 å…ƒ</span>
            </div>
            <div class="portfolio-item">
                <span>å½“å‰ä»·å€¼:</span>
                <span id="portfolio-value">100,000.00 å…ƒ</span>
            </div>
            <div class="portfolio-item">
                <span>æ€»ç›ˆäº:</span>
                <span id="portfolio-pnl" class="profit-neutral">0.00 å…ƒ (0.00%)</span>
            </div>
            <div class="portfolio-item">
                <span>å¤æ™®æ¯”ç‡:</span>
                <span id="sharpe-ratio">0.00</span>
            </div>
            <div class="portfolio-item">
                <span>æœ€å¤§å›æ’¤:</span>
                <span id="max-drawdown">0.00%</span>
            </div>
            
            <div class="scenario-title">èµ„äº§åˆ†å¸ƒ</div>
            <div id="asset-allocation" style="height: 200px; background-color: #f9f9f9; display: flex; align-items: center; justify-content: center; margin-top: 15px; border-radius: 4px;">
                <canvas id="allocationChart"></canvas>
            </div>
            
            <div class="scenario-title">å†å²è¡¨ç°</div>
            <div id="performance-chart" style="height: 200px; background-color: #f9f9f9; display: flex; align-items: center; justify-content: center; margin-top: 15px; border-radius: 4px;">
                <canvas id="performanceCanvas"></canvas>
            </div>
            
            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn btn-info" id="rebalance-portfolio">é‡æ–°å¹³è¡¡ç»„åˆ</button>
                <button class="btn btn-info" id="diversify-portfolio">åˆ†æ•£æŠ•èµ„</button>
                <button class="btn btn-info" id="export-portfolio">å¯¼å‡ºç»„åˆæ•°æ®</button>
            </div>
        </div>
        
        <div class="tab-content" id="strategies-tab">
            <h3>è‡ªåŠ¨åŒ–äº¤æ˜“ç­–ç•¥</h3>
            <p>è®¾ç½®è‡ªåŠ¨æ‰§è¡Œçš„äº¤æ˜“ç­–ç•¥</p>
            
            <div class="strategy-controls">
                <div class="form-group">
                    <label for="strategy-select">é€‰æ‹©ç­–ç•¥</label>
                    <select id="strategy-select" class="btn">
                        <option value="mean-reversion">å‡å€¼å›å½’</option>
                        <option value="momentum">åŠ¨é‡ç­–ç•¥</option>
                        <option value="arbitrage">å¥—åˆ©ç­–ç•¥</option>
                        <option value="grid">ç½‘æ ¼äº¤æ˜“</option>
                        <option value="martingale">é©¬ä¸æ ¼å°”</option>
                        <option value="dca">å®šæŠ•ç­–ç•¥</option>
                        <option value="custom">è‡ªå®šä¹‰ç­–ç•¥</option>
                    </select>
                </div>
                
                <div id="mean-reversion-params" class="strategy-params">
                    <div class="form-group">
                        <label for="mr-period">è§‚å¯Ÿå‘¨æœŸ (å¤©)</label>
                        <input type="number" id="mr-period" min="5" max="365" value="20">
                    </div>
                    <div class="form-group">
                        <label for="mr-deviation">æ ‡å‡†å·®å€æ•°</label>
                        <input type="number" id="mr-deviation" min="1" max="5" step="0.1" value="2">
                    </div>
                </div>
                
                <div id="momentum-params" class="strategy-params" style="display: none;">
                    <div class="form-group">
                        <label for="momentum-period">åŠ¨é‡å‘¨æœŸ (å¤©)</label>
                        <input type="number" id="momentum-period" min="5" max="365" value="10">
                    </div>
                    <div class="form-group">
                        <label for="momentum-threshold">é˜ˆå€¼ (%)</label>
                        <input type="number" id="momentum-threshold" min="1" max="50" value="5">
                    </div>
                </div>
                
                <div id="grid-params" class="strategy-params" style="display: none;">
                    <div class="form-group">
                        <label for="grid-upper">ä¸Šé™ä»·æ ¼</label>
                        <input type="number" id="grid-upper" min="0.0001" step="0.0001" value="6.00">
                    </div>
                    <div class="form-group">
                        <label for="grid-lower">ä¸‹é™ä»·æ ¼</label>
                        <input type="number" id="grid-lower" min="0.0001" step="0.0001" value="4.00">
                    </div>
                    <div class="form-group">
                        <label for="grid-levels">ç½‘æ ¼å±‚æ•°</label>
                        <input type="number" id="grid-levels" min="3" max="100" value="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="strategy-capital">ç­–ç•¥èµ„é‡‘ (%)</label>
                    <input type="range" id="strategy-capital" min="1" max="100" value="20">
                    <span id="strategy-capital-value">20%</span>
                </div>
                
                <button id="activate-strategy" class="btn btn-success">æ¿€æ´»ç­–ç•¥</button>
                <button id="backtest-strategy" class="btn btn-info">å›æµ‹ç­–ç•¥</button>
                <button id="stop-strategy" class="btn btn-warning">åœæ­¢ç­–ç•¥</button>
                
                <div id="strategy-status" style="margin-top: 15px; padding: 10px; background-color: #e8f5e9; border-radius: 4px; display: none;">
                    <p><strong>ç­–ç•¥è¿è¡Œä¸­:</strong> <span id="active-strategy-name"></span></p>
                    <p>å·²æ‰§è¡Œäº¤æ˜“: <span id="strategy-trades">0</span> æ¬¡</p>
                    <p>ç­–ç•¥ç›ˆäº: <span id="strategy-pnl">0.00 å…ƒ</span></p>
                </div>
            </div>
            
            <div class="scenario-title">ç­–ç•¥å›æµ‹ç»“æœ</div>
            <div id="backtest-results" style="height: 200px; overflow-y: auto; margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 4px; display: none;">
                <!-- å›æµ‹ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        
        <div class="tab-content" id="news-tab">
            <h3>å¸‚åœºæ–°é—»ä¸äº‹ä»¶</h3>
            <div class="btn-group">
                <button class="btn btn-info" id="generate-news">ç”Ÿæˆéšæœºæ–°é—»</button>
                <button class="btn btn-info" id="clear-news">æ¸…ç©ºæ–°é—»</button>
            </div>
            
            <div id="news-container" style="margin-top: 15px;">
                <!-- æ–°é—»å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label for="custom-news">è‡ªå®šä¹‰æ–°é—»å†…å®¹</label>
                <input type="text" id="custom-news" placeholder="è¾“å…¥æ–°é—»æ ‡é¢˜">
                <select id="news-sentiment" style="margin-top: 5px;">
                    <option value="positive">åˆ©å¥½</option>
                    <option value="negative">åˆ©ç©º</option>
                    <option value="neutral">ä¸­æ€§</option>
                </select>
                <button id="submit-custom-news" class="btn btn-primary" style="margin-top: 10px;">å‘å¸ƒæ–°é—»</button>
            </div>
            
            <div class="scenario-title">ç¤¾äº¤åª’ä½“æƒ…ç»ª</div>
            <div class="social-sentiment">
                <span>Twitter:</span>
                <div class="sentiment-bar">
                    <div class="sentiment-fill" id="twitter-sentiment"></div>
                </div>
                <span class="sentiment-value" id="twitter-value">50%</span>
            </div>
            
            <div class="social-sentiment">
                <span>Reddit:</span>
                <div class="sentiment-bar">
                    <div class="sentiment-fill" id="reddit-sentiment"></div>
                </div>
                <span class="sentiment-value" id="reddit-value">50%</span>
            </div>
            
            <div class="social-sentiment">
                <span>Telegram:</span>
                <div class="sentiment-bar">
                    <div class="sentiment-fill" id="telegram-sentiment"></div>
                </div>
                <span class="sentiment-value" id="telegram-value">50%</span>
            </div>
        </div>
        
        <div class="tab-content" id="derivatives-tab">
            <div class="derivatives-panel">
                <h3>è¡ç”Ÿå“äº¤æ˜“</h3>
                <p>æ¨¡æ‹ŸæœŸè´§ã€æœŸæƒå’Œå…¶ä»–è¡ç”Ÿå“äº¤æ˜“</p>
                
                <div class="tab-container" style="margin-top: 15px;">
                    <div class="tab active" data-tab="futures">æœŸè´§åˆçº¦</div>
                    <div class="tab" data-tab="options">æœŸæƒåˆçº¦</div>
                    <div class="tab" data-tab="swaps">æ°¸ç»­åˆçº¦</div>
                </div>
                
                <div class="tab-content active" id="futures-tab">
                    <div class="form-group">
                        <label for="futures-expiry">åˆ°æœŸæ—¶é—´</label>
                        <select id="futures-expiry" class="btn">
                            <option value="weekly">æœ¬å‘¨</option>
                            <option value="monthly">æœ¬æœˆ</option>
                            <option value="quarterly">æœ¬å­£åº¦</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="futures-price">æœŸè´§ä»·æ ¼</label>
                        <input type="number" id="futures-price" min="0.0001" step="0.0001" value="5.00" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="futures-premium">æº¢ä»· (%)</label>
                        <input type="number" id="futures-premium" min="-10" max="10" step="0.1" value="0.5" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="futures-amount">åˆçº¦æ•°é‡</label>
                        <input type="number" id="futures-amount" min="1" max="100" value="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="futures-leverage">æ æ†å€æ•°</label>
                        <select id="futures-leverage" class="btn">
                            <option value="1">1Ã—</option>
                            <option value="5">5Ã—</option>
                            <option value="10">10Ã—</option>
                            <option value="20">20Ã—</option>
                            <option value="50">50Ã—</option>
                        </select>
                    </div>
                    
                    <button id="buy-futures" class="btn btn-down">ä¹°å…¥åšå¤š</button>
                    <button id="sell-futures" class="btn btn-up">å–å‡ºåšç©º</button>
                    
                    <div id="futures-positions" style="margin-top: 15px;">
                        <h4>æˆ‘çš„æœŸè´§æŒä»“</h4>
                        <div id="futures-list">
                            <!-- æœŸè´§æŒä»“å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="options-tab">
                    <div class="form-group">
                        <label for="options-type">æœŸæƒç±»å‹</label>
                        <select id="options-type" class="btn">
                            <option value="call">çœ‹æ¶¨æœŸæƒ</option>
                            <option value="put">çœ‹è·ŒæœŸæƒ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="options-strike">è¡Œæƒä»·æ ¼</label>
                        <input type="number" id="options-strike" min="0.0001" step="0.0001" value="5.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="options-expiry">åˆ°æœŸæ—¶é—´</label>
                        <select id="options-expiry" class="btn">
                            <option value="weekly">æœ¬å‘¨</option>
                            <option value="monthly">æœ¬æœˆ</option>
                            <option value="quarterly">æœ¬å­£åº¦</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="options-premium">æœŸæƒè´¹</label>
                        <input type="number" id="options-premium" min="0.0001" step="0.0001" value="0.20" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="options-amount">åˆçº¦æ•°é‡</label>
                        <input type="number" id="options-amount" min="1" max="100" value="1">
                    </div>
                    
                    <button id="buy-options" class="btn btn-down">ä¹°å…¥æœŸæƒ</button>
                    <button id="sell-options" class="btn btn-up">å–å‡ºæœŸæƒ</button>
                    
                    <div id="options-positions" style="margin-top: 15px;">
                        <h4>æˆ‘çš„æœŸæƒæŒä»“</h4>
                        <div id="options-list">
                            <!-- æœŸæƒæŒä»“å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="swaps-tab">
                    <div class="form-group">
                        <label for="swap-price">æ°¸ç»­åˆçº¦ä»·æ ¼</label>
                        <input type="number" id="swap-price" min="0.0001" step="0.0001" value="5.00" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="swap-funding">èµ„é‡‘è´¹ç‡ (%)</label>
                        <input type="number" id="swap-funding" min="-1" max="1" step="0.0001" value="0.01" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="swap-amount">åˆçº¦æ•°é‡</label>
                        <input type="number" id="swap-amount" min="1" max="100" value="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="swap-leverage">æ æ†å€æ•°</label>
                        <select id="swap-leverage" class="btn">
                            <option value="1">1Ã—</option>
                            <option value="5">5Ã—</option>
                            <option value="10">10Ã—</option>
                            <option value="20">20Ã—</option>
                            <option value="50">50Ã—</option>
                            <option value="100">100Ã—</option>
                        </select>
                    </div>
                    
                    <button id="long-swap" class="btn btn-down">åšå¤š</button>
                    <button id="short-swap" class="btn btn-up">åšç©º</button>
                    
                    <div id="swap-positions" style="margin-top: 15px;">
                        <h4>æˆ‘çš„æ°¸ç»­åˆçº¦</h4>
                        <div id="swap-list">
                            <!-- æ°¸ç»­åˆçº¦æŒä»“å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="scenario-title">è¡ç”Ÿå“é£é™©åˆ†æ</div>
            <div id="derivatives-risk" style="height: 150px; background-color: #f9f9f9; display: flex; align-items: center; justify-content: center; margin-top: 15px; border-radius: 4px;">
                <canvas id="riskChart"></canvas>
            </div>
            
            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn btn-info" id="hedge-portfolio">å¯¹å†²æŠ•èµ„ç»„åˆ</button>
                <button class="btn btn-info" id="simulate-expiry">æ¨¡æ‹Ÿåˆ°æœŸç»“ç®—</button>
                <button class="btn btn-warning" id="liquidate-derivatives">å¹³ä»“æ‰€æœ‰è¡ç”Ÿå“</button>
            </div>
        </div>
    </div>
    
    <div class="trade-section">
        <div class="trade-panel" id="buyPanel">
            <h3>ä¹°å…¥æ³¢åŠ¨å¸</h3>
            <div class="form-group">
                <label for="buy-amount">ä¹°å…¥æ•°é‡</label>
                <input type="number" id="buy-amount" min="0.01" step="0.01" value="10">
            </div>
            <div class="form-group">
                <label>é¢„ä¼°æˆæœ¬</label>
                <div id="buy-total">53.20 å…ƒ</div>
            </div>
            <div class="form-group">
                <label>å¸‚åœºå½±å“</label>
                <div id="buy-impact">+0.05% (è½»å¾®)</div>
            </div>
            <div class="form-group">
                <label for="buy-order-type">è®¢å•ç±»å‹</label>
                <select id="buy-order-type" class="btn">
                    <option value="market">å¸‚ä»·å•</option>
                    <option value="limit">é™ä»·å•</option>
                </select>
            </div>
            <div class="form-group" id="buy-limit-group" style="display: none;">
                <label for="buy-limit-price">é™ä»·</label>
                <input type="number" id="buy-limit-price" min="0.0001" step="0.0001" value="5.00">
            </div>
            <button id="buy-btn" class="btn btn-down">ç¡®è®¤ä¹°å…¥</button>
            <button id="buy-stop-limit" class="btn btn-warning">æ­¢æŸé™ä»·å•</button>
        </div>
        
        <div class="trade-panel" id="sellPanel">
            <h3>å–å‡ºæ³¢åŠ¨å¸</h3>
            <div class="form-group">
                <label for="sell-amount">å–å‡ºæ•°é‡</label>
                <input type="number" id="sell-amount" min="0.01" step="0.01" value="10">
            </div>
            <div class="form-group">
                <label>é¢„ä¼°æ”¶å…¥</label>
                <div id="sell-total">53.20 å…ƒ</div>
            </div>
            <div class="form-group">
                <label>å¸‚åœºå½±å“</label>
                <div id="sell-impact">-0.05% (è½»å¾®)</div>
            </div>
            <div class="form-group">
                <label for="sell-order-type">è®¢å•ç±»å‹</label>
                <select id="sell-order-type" class="btn">
                    <option value="market">å¸‚ä»·å•</option>
                    <option value="limit">é™ä»·å•</option>
                </select>
            </div>
            <div class="form-group" id="sell-limit-group" style="display: none;">
                <label for="sell-limit-price">é™ä»·</label>
                <input type="number" id="sell-limit-price" min="0.0001" step="0.0001" value="5.00">
            </div>
            <button id="sell-btn" class="btn btn-up">ç¡®è®¤å–å‡º</button>
            <button id="sell-stop-limit" class="btn btn-warning">æ­¢æŸé™ä»·å•</button>
        </div>
    </div>
    
    <div class="panel">
        <h2>ä»·æ ¼èµ°åŠ¿ä¸åˆ†æ <span style="font-size: 14px; font-weight: normal;">(æ”¯æŒç¼©æ”¾å’Œæ‹–åŠ¨)</span></h2>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
    </div>
    
    <div class="panel">
        <h2>äº¤æ˜“è®°å½•</h2>
        <div class="transaction-history" id="transaction-history">
            <!-- äº¤æ˜“è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        let currentPrice = 5.00;
        let priceHistory = generateInitialHistory(30, 4.5, 6.0);
        let autoIntervalId = null;
        let currentMode = 'random';
        let marketCap = 10;
        let dailyVolume = 0;
        let high24h = 0;
        let low24h = 0;
        let totalSupply = 10000000;
        let userCash = 100000;
        let userCoins = 0;
        let userLeverage = 1;
        let leveragedPositions = [];
        let transactions = [];
        let supportLevel = 4.8;
        let resistanceLevel = 5.5;
        let chart = null;
        let trendDirection = 0;
        let trendCount = 0;
        let isBullMarket = false;
        let isBearMarket = false;
        let isTradingHalted = false;
        let rollercoasterPhase = 0;
        let marketSentiment = 50;
        let twitterSentiment = 50;
        let redditSentiment = 50;
        let telegramSentiment = 50;
        let initialBalance = 100000;
        let dailyHighBalance = 100000;
        let dailyLowBalance = 100000;
        let portfolioHistory = [];
        let activeStrategy = null;
        let strategyTrades = 0;
        let strategyProfit = 0;
        let orderBook = {
            bids: [],
            asks: []
        };
        let userOrders = [];
        let futuresPositions = [];
        let optionsPositions = [];
        let swapPositions = [];
        let allocationChart = null;
        let performanceChart = null;
        let riskChart = null;
        let depthChart = null;
        let isDarkMode = false;
        
        // ç”Ÿæˆåˆå§‹å†å²æ•°æ®
        function generateInitialHistory(days, minPrice, maxPrice) {
            let history = [];
            for (let i = 0; i < days; i++) {
                history.push(Number((Math.random() * (maxPrice - minPrice) + minPrice).toFixed(2));
            }
            return history;
        }
        
        // ç”Ÿæˆæ—¥æœŸæ ‡ç­¾
        function generateDateLabels(count) {
            const labels = [];
            const today = new Date();
            for (let i = count - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(formatDate(date));
            }
            return labels;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return `${date.getMonth()+1}/${date.getDate()}`;
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: generateDateLabels(priceHistory.length),
                    datasets: [{
                        label: 'æ³¢åŠ¨å¸ä»·æ ¼ (å…ƒ)',
                        data: priceHistory,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy'
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy'
                            }
                        },
                        legend: {
                            labels: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        },
                        annotation: {
                            annotations: {
                                supportLine: {
                                    type: 'line',
                                    yMin: supportLevel,
                                    yMax: supportLevel,
                                    borderColor: 'rgb(76, 175, 80)',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    display: false
                                },
                                resistanceLine: {
                                    type: 'line',
                                    yMin: resistanceLevel,
                                    yMax: resistanceLevel,
                                    borderColor: 'rgb(244, 67, 54)',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    display: false
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    }
                }
            });
            
            // åˆå§‹åŒ–æ·±åº¦å›¾
            initDepthChart();
            
            // åˆå§‹åŒ–èµ„äº§åˆ†é…å›¾
            initAllocationChart();
            
            // åˆå§‹åŒ–è¡¨ç°å›¾
            initPerformanceChart();
            
            // åˆå§‹åŒ–é£é™©å›¾
            initRiskChart();
        }
        
        // åˆå§‹åŒ–æ·±åº¦å›¾
        function initDepthChart() {
            const ctx = document.getElementById('depthChart').getContext('2d');
            depthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'ä¹°å•æ·±åº¦',
                            data: [],
                            backgroundColor: 'rgba(76, 175, 80, 0.5)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'å–å•æ·±åº¦',
                            data: [],
                            backgroundColor: 'rgba(244, 67, 54, 0.5)',
                            borderColor: 'rgba(244, 67, 54, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        },
                        y: {
                            stacked: true,
                            grid: {
                                color: isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        }
                    }
                }
            });
            
            updateDepthChart();
        }
        
        // åˆå§‹åŒ–èµ„äº§åˆ†é…å›¾
        function initAllocationChart() {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ç°é‡‘', 'æ³¢åŠ¨å¸', 'æœŸè´§', 'æœŸæƒ', 'æ°¸ç»­åˆçº¦'],
                    datasets: [{
                        data: [100, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        }
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–è¡¨ç°å›¾
        function initPerformanceChart() {
            const ctx = document.getElementById('performanceCanvas').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æŠ•èµ„ç»„åˆä»·å€¼',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        }
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–é£é™©å›¾
        function initRiskChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['å¸‚åœºé£é™©', 'æ æ†é£é™©', 'æµåŠ¨æ€§é£é™©', 'æ³¢åŠ¨æ€§é£é™©', 'å¯¹æ‰‹æ–¹é£é™©'],
                    datasets: [{
                        label: 'é£é™©æš´éœ²',
                        data: [20, 10, 15, 25, 5],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                color: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                            },
                            grid: {
                                color: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                            },
                            pointLabels: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            },
                            ticks: {
                                backdropColor: isDarkMode ? '#121212' : '#ffffff',
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: isDarkMode ? '#ffffff' : '#333333'
                            }
                        }
                    }
                }
            });
        }
        
        // æ›´æ–°å¸‚åœºæ•°æ®
        function updateMarketData(newPrice) {
            // æ›´æ–°24å°æ—¶é«˜/ä½ä»·
            if (newPrice > high24h || high24h === 0) high24h = newPrice;
            if (newPrice < low24h || low24h === 0) low24h = newPrice;
            
            // æ›´æ–°å¸‚å€¼
            marketCap = totalSupply * newPrice;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('market-cap').textContent = marketCap.toLocaleString('zh-CN', {maximumFractionDigits: 0});
            document.getElementById('volume').textContent = dailyVolume.toLocaleString('zh-CN', {maximumFractionDigits: 0});
            document.getElementById('high-price').textContent = high24h.toFixed(2);
            document.getElementById('low-price').textContent = low24h.toFixed(2);
            
            // æ›´æ–°è¡ç”Ÿå“ä»·æ ¼
            updateDerivativesPrices();
        }
        
        // æ›´æ–°è¡ç”Ÿå“ä»·æ ¼
        function updateDerivativesPrices() {
            // æœŸè´§ä»·æ ¼ (å½“å‰ä»·æ ¼åŠ ä¸Šå°é¢æº¢ä»·)
            const futuresPremium = 0.005 * currentPrice;
            document.getElementById('futures-price').value = (currentPrice + futuresPremium).toFixed(4);
            document.getElementById('futures-premium').value = (futuresPremium / currentPrice * 100).toFixed(2);
            
            // æœŸæƒè´¹ (åŸºäºæ³¢åŠ¨ç‡)
            const volatility = calculateVolatility();
            document.getElementById('options-premium').value = (currentPrice * volatility * 0.05).toFixed(4);
            
            // æ°¸ç»­åˆçº¦ä»·æ ¼ (æ¥è¿‘ç°è´§ä»·æ ¼)
            document.getElementById('swap-price').value = currentPrice.toFixed(4);
            
            // èµ„é‡‘è´¹ç‡ (éšæœºå°å¹…æ³¢åŠ¨)
            const fundingRate = (Math.random() * 0.02 - 0.01).toFixed(4);
            document.getElementById('swap-funding').value = fundingRate;
        }
        
        // è®¡ç®—æ³¢åŠ¨ç‡
        function calculateVolatility() {
            if (priceHistory.length < 2) return 0;
            
            let sum = 0;
            let sumSq = 0;
            let count = 0;
            
            for (let i = 1; i < priceHistory.length; i++) {
                const change = (priceHistory[i] - priceHistory[i-1]) / priceHistory[i-1];
                sum += change;
                sumSq += change * change;
                count++;
            }
            
            const mean = sum / count;
            const variance = (sumSq - (sum * sum) / count) / count;
            return Math.sqrt(variance) * Math.sqrt(365); // å¹´åŒ–æ³¢åŠ¨ç‡
        }
        
        // æ›´æ–°ç”¨æˆ·èµ„äº§
        function updateUserBalance() {
            const coinValue = userCoins * currentPrice;
            const totalAssets = userCash + coinValue + calculateDerivativesValue();
            
            // æ›´æ–°æ¯æ—¥ç›ˆäº
            updateDailyPnL(totalAssets);
            
            document.getElementById('cash-balance').textContent = userCash.toFixed(2) + ' å…ƒ';
            document.getElementById('coin-balance').textContent = userCoins.toFixed(2) + ' æ³¢åŠ¨å¸';
            document.getElementById('contract-balance').textContent = futuresPositions.length + optionsPositions.length + swapPositions.length + ' å¼ ';
            document.getElementById('total-assets').textContent = totalAssets.toFixed(2) + ' å…ƒ';
            document.getElementById('leverage').textContent = userLeverage + 'Ã—';
            
            // æ›´æ–°æŠ•èµ„ç»„åˆä»·å€¼
            document.getElementById('portfolio-value').textContent = totalAssets.toFixed(2) + ' å…ƒ';
            
            // æ›´æ–°æ€»ç›ˆäº
            const pnl = totalAssets - initialBalance;
            const pnlPercent = (pnl / initialBalance * 100).toFixed(2);
            const pnlElement = document.getElementById('portfolio-pnl');
            pnlElement.textContent = `${pnl.toFixed(2)} å…ƒ (${pnlPercent}%)`;
            
            if (pnl > 0) {
                pnlElement.className = 'portfolio-profit profit-positive';
            } else if (pnl < 0) {
                pnlElement.className = 'portfolio-profit profit-negative';
            } else {
                pnlElement.className = 'portfolio-profit profit-neutral';
            }
            
            // æ›´æ–°ä¹°å–è¡¨å•çš„æœ€å¤§å€¼
            document.getElementById('sell-amount').max = userCoins.toFixed(2);
            
            // æ›´æ–°èµ„äº§åˆ†é…å›¾
            updateAllocationChart(coinValue, totalAssets);
            
            // æ›´æ–°æŠ•èµ„ç»„åˆå†å²
            updatePortfolioHistory(totalAssets);
        }
        
        // è®¡ç®—è¡ç”Ÿå“ä»·å€¼
        function calculateDerivativesValue() {
            let value = 0;
            
            // æœŸè´§ä»·å€¼
            futuresPositions.forEach(position => {
                const priceDiff = currentPrice - position.entryPrice;
                value += position.amount * (position.type === 'long' ? priceDiff : -priceDiff);
            });
            
            // æœŸæƒä»·å€¼ (ç®€åŒ–è®¡ç®—)
            optionsPositions.forEach(option => {
                const intrinsicValue = option.type === 'call' 
                    ? Math.max(0, currentPrice - option.strike)
                    : Math.max(0, option.strike - currentPrice);
                value += option.amount * intrinsicValue;
            });
            
            // æ°¸ç»­åˆçº¦ä»·å€¼
            swapPositions.forEach(swap => {
                const priceDiff = currentPrice - swap.entryPrice;
                value += swap.amount * (swap.type === 'long' ? priceDiff : -priceDiff) * swap.leverage;
            });
            
            return value;
        }
        
        // æ›´æ–°æ¯æ—¥ç›ˆäº
        function updateDailyPnL(totalAssets) {
            if (totalAssets > dailyHighBalance) dailyHighBalance = totalAssets;
            if (totalAssets < dailyLowBalance) dailyLowBalance = totalAssets;
            
            const dailyPnL = totalAssets - 100000; // ç®€åŒ–è®¡ç®—
            const dailyPnLPercent = (dailyPnL / 100000 * 100).toFixed(2);
            const dailyPnLElement = document.getElementById('daily-pnl');
            dailyPnLElement.textContent = `${dailyPnL.toFixed(2)} å…ƒ (${dailyPnLPercent}%)`;
            
            if (dailyPnL > 0) {
                dailyPnLElement.className = 'profit-positive';
            } else if (dailyPnL < 0) {
                dailyPnLElement.className = 'profit-negative';
            } else {
                dailyPnLElement.className = 'profit-neutral';
            }
        }
        
        // æ›´æ–°èµ„äº§åˆ†é…å›¾
        function updateAllocationChart(coinValue, totalAssets) {
            if (!allocationChart) return;
            
            const derivativesValue = calculateDerivativesValue();
            const cashPercent = (userCash / totalAssets * 100).toFixed(2);
            const coinPercent = (coinValue / totalAssets * 100).toFixed(2);
            const derivativesPercent = (derivativesValue / totalAssets * 100).toFixed(2);
            
            allocationChart.data.datasets[0].data = [
                cashPercent,
                coinPercent,
                derivativesPercent * 0.4, // æœŸè´§
                derivativesPercent * 0.3, // æœŸæƒ
                derivativesPercent * 0.3  // æ°¸ç»­
            ];
            
            allocationChart.update();
        }
        
        // æ›´æ–°æŠ•èµ„ç»„åˆå†å²
        function updatePortfolioHistory(totalAssets) {
            const now = new Date();
            const timeLabel = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            portfolioHistory.push({
                time: timeLabel,
                value: totalAssets
            });
            
            // ä¿æŒæœ€å¤š50ä¸ªæ•°æ®ç‚¹
            if (portfolioHistory.length > 50) {
                portfolioHistory.shift();
            }
            
            // æ›´æ–°è¡¨ç°å›¾
            updatePerformanceChart();
            
            // æ›´æ–°é£é™©å›¾
            updateRiskChart();
        }
        
        // æ›´æ–°è¡¨ç°å›¾
        function updatePerformanceChart() {
            if (!performanceChart) return;
            
            performanceChart.data.labels = portfolioHistory.map(item => item.time);
            performanceChart.data.datasets[0].data = portfolioHistory.map(item => item.value);
            performanceChart.update();
        }
        
        // æ›´æ–°é£é™©å›¾
        function updateRiskChart() {
            if (!riskChart) return;
            
            // ç®€åŒ–é£é™©è®¡ç®—
            const marketRisk = Math.min(100, Math.max(0, calculateVolatility() * 500));
            const leverageRisk = Math.min(100, Math.max(0, userLeverage * 10));
            const liquidityRisk = Math.min(100, Math.max(0, 20 + (userCoins / totalSupply * 80)));
            const volatilityRisk = Math.min(100, Math.max(0, calculateVolatility() * 300));
            const counterpartyRisk = 5; // å‡è®¾å›ºå®š
            
            riskChart.data.datasets[0].data = [
                marketRisk,
                leverageRisk,
                liquidityRisk,
                volatilityRisk,
                counterpartyRisk
            ];
            
            riskChart.update();
        }
        
        // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
        function updatePriceDisplay(newPrice, oldPrice) {
            if(isTradingHalted) return;
            
            const changeAmount = newPrice - oldPrice;
            const changePercent = (changeAmount / oldPrice) * 100;
            
            document.getElementById('current-price').textContent = newPrice.toFixed(2);
            
            if (changeAmount >= 0) {
                document.getElementById('price-change').textContent = 
                    `+${changeAmount.toFixed(2)} (${changePercent.toFixed(2)}%)`;
                document.getElementById('price-change').className = 'price-change up';
            } else {
                document.getElementById('price-change').textContent = 
                    `${changeAmount.toFixed(2)} (${changePercent.toFixed(2)}%)`;
                document.getElementById('price-change').className = 'price-change down';
            }
            
            // æ›´æ–°å¸‚åœºæ•°æ®
            updateMarketData(newPrice);
            
            // æ›´æ–°ä»·æ ¼å†å²
            priceHistory.shift();
            priceHistory.push(newPrice);
            updateChart();
            
            // æ›´æ–°ä¹°å–è¡¨å•
            updateTradeForms();
            
            // æ£€æŸ¥æ æ†ä»“ä½
            checkLeveragedPositions();
            
            // æ£€æŸ¥æ­¢æŸæ­¢ç›ˆè®¢å•
            checkStopOrders(newPrice);
            
            // æ›´æ–°è®¢å•ç°¿
            updateOrderBook(newPrice);
            
            // æ›´æ–°å¸‚åœºæƒ…ç»ª
            updateMarketSentiment(changePercent);
        }
        
        // æ›´æ–°å¸‚åœºæƒ…ç»ª
        function updateMarketSentiment(changePercent) {
            // ä»·æ ¼å˜åŒ–å½±å“æƒ…ç»ª
            marketSentiment += changePercent * 0.5;
            marketSentiment = Math.max(0, Math.min(100, marketSentiment));
            
            // ç¤¾äº¤åª’ä½“æƒ…ç»ªè·Ÿéšå¸‚åœºæƒ…ç»ªä½†æœ‰éšæœºæ³¢åŠ¨
            twitterSentiment = Math.max(0, Math.min(100, marketSentiment + (Math.random() * 20 - 10)));
            redditSentiment = Math.max(0, Math.min(100, marketSentiment + (Math.random() * 30 - 15)));
            telegramSentiment = Math.max(0, Math.min(100, marketSentiment + (Math.random() * 40 - 20)));
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('sentiment-fill').style.width = `${marketSentiment}%`;
            document.getElementById('sentiment-value').textContent = `${marketSentiment.toFixed(0)}%`;
            
            document.getElementById('twitter-sentiment').style.width = `${twitterSentiment}%`;
            document.getElementById('twitter-value').textContent = `${twitterSentiment.toFixed(0)}%`;
            
            document.getElementById('reddit-sentiment').style.width = `${redditSentiment}%`;
            document.getElementById('reddit-value').textContent = `${redditSentiment.toFixed(0)}%`;
            
            document.getElementById('telegram-sentiment').style.width = `${telegramSentiment}%`;
            document.getElementById('telegram-value').textContent = `${telegramSentiment.toFixed(0)}%`;
            
            // æ ¹æ®æƒ…ç»ªè°ƒæ•´å¸‚åœºè¡Œä¸º
            if (marketSentiment > 70 && Math.random() > 0.7) {
                // å¸‚åœºæƒ…ç»ªé«˜æ¶¨ï¼Œå¯èƒ½è¿‡åº¦ä¹°å…¥
                changePrice(0.01, 'sentiment');
            } else if (marketSentiment < 30 && Math.random() > 0.7) {
                // å¸‚åœºæƒ…ç»ªä½è½ï¼Œå¯èƒ½è¿‡åº¦å–å‡º
                changePrice(-0.01, 'sentiment');
            }
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateChart() {
            if (chart) {
                chart.data.datasets[0].data = priceHistory;
                
                // æ›´æ–°æ”¯æ’‘ä½å’Œé˜»åŠ›ä½æ³¨é‡Š
                chart.options.plugins.annotation.annotations.supportLine.yMin = supportLevel;
                chart.options.plugins.annotation.annotations.supportLine.yMax = supportLevel;
                chart.options.plugins.annotation.annotations.resistanceLine.yMin = resistanceLevel;
                chart.options.plugins.annotation.annotations.resistanceLine.yMax = resistanceLevel;
                
                chart.update();
            }
        }
        
        // æ›´æ–°ä¹°å–è¡¨å•
        function updateTradeForms() {
            const buyAmount = parseFloat(document.getElementById('buy-amount').value) || 0;
            const sellAmount = parseFloat(document.getElementById('sell-amount').value) || 0;
            
            document.getElementById('buy-total').textContent = (buyAmount * currentPrice).toFixed(2) + ' å…ƒ';
            document.getElementById('sell-total').textContent = (sellAmount * currentPrice).toFixed(2) + ' å…ƒ';
            
            // è®¡ç®—å¸‚åœºå½±å“
            const buyImpact = calculateMarketImpact(buyAmount, 'buy');
            const sellImpact = calculateMarketImpact(sellAmount, 'sell');
            
            document.getElementById('buy-impact').textContent = 
                `${(buyImpact * 100).toFixed(2)}% (${getImpactLevel(buyImpact)})`;
            document.getElementById('sell-impact').textContent = 
                `${(sellImpact * 100).toFixed(2)}% (${getImpactLevel(sellImpact)})`;
            
            // æ›´æ–°é™ä»·å•ä»·æ ¼
            document.getElementById('buy-limit-price').value = currentPrice.toFixed(2);
            document.getElementById('sell-limit-price').value = currentPrice.toFixed(2);
            document.getElementById('place-order-price').value = currentPrice.toFixed(2);
        }
        
        // è®¡ç®—å¸‚åœºå½±å“
        function calculateMarketImpact(amount, type) {
            const baseImpact = 0.0001; // åŸºç¡€å½±å“ç³»æ•°
            const totalDailyVolume = dailyVolume / currentPrice; // è½¬æ¢ä¸ºå¸æ•°é‡
            
            // å½±å“ä¸äº¤æ˜“é‡å æ€»æµé€šé‡çš„æ¯”ä¾‹ç›¸å…³
            let impact = (amount / totalDailyVolume) * baseImpact * 100;
            
            // ä¹°å–å½±å“ä¸åŒ
            if (type === 'buy') {
                // ä¹°å…¥ä¼šæ¨é«˜ä»·æ ¼
                return impact;
            } else {
                // å–å‡ºä¼šå‹ä½ä»·æ ¼
                return -impact;
            }
        }
        
        // è·å–å½±å“çº§åˆ«æè¿°
        function getImpactLevel(impact) {
            impact = Math.abs(impact);
            if (impact < 0.001) return 'æå°';
            if (impact < 0.005) return 'è½»å¾®';
            if (impact < 0.01) return 'ä¸­ç­‰';
            if (impact < 0.05) return 'æ˜¾è‘—';
            return 'å·¨å¤§';
        }
        
        // æ”¹å˜ä»·æ ¼
        function changePrice(changePercent, source) {
            if(isTradingHalted) {
                showNotification("å¸‚åœºæš‚åœäº¤æ˜“ä¸­ï¼Œæ— æ³•æ”¹å˜ä»·æ ¼", "error");
                return 0;
            }
            
            const oldPrice = currentPrice;
            let newPrice = currentPrice * (1 + changePercent);
            
            // ç¡®ä¿ä»·æ ¼ä¸ä¼šä½äº0.01å…ƒ
            if (newPrice < 0.00001) newPrice = 0.000001;
            
            // åº”ç”¨ä»·æ ¼å˜åŒ–
            currentPrice = parseFloat(newPrice.toFixed(4));
            
            // å¦‚æœæ˜¯äº¤æ˜“å¼•èµ·çš„ä»·æ ¼å˜åŒ–ï¼Œå¢åŠ æˆäº¤é‡
            if (source === 'trade') {
                const tradeAmount = Math.abs(changePercent) * totalSupply * 10; // æ¨¡æ‹Ÿäº¤æ˜“é‡
                dailyVolume += tradeAmount * currentPrice;
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updatePriceDisplay(currentPrice, oldPrice);
            
            // è¿”å›å®é™…å˜åŒ–ç™¾åˆ†æ¯”
            return (currentPrice - oldPrice) / oldPrice;
        }
        
        // éšæœºæ³¢åŠ¨
        function randomFluctuation() {
            if(isTradingHalted) return;
            
            let changePercent;
            
            switch(currentMode) {
                case 'random':
                    // éšæœºæ³¢åŠ¨ (Â±5%)
                    changePercent = (Math.random() * 0.1 - 0.05);
                    break;
                
                case 'sideways':
                    // æ¨ªç›˜éœ‡è¡ (Â±1%)
                    changePercent = (Math.random() * 0.02 - 0.01);
                    break;
                
                case 'volatile':
                    // å‰§çƒˆæ³¢åŠ¨ (Â±15%)
                    changePercent = (Math.random() * 0.3 - 0.15);
                    break;
                
                case 'trend':
                    // è¶‹åŠ¿æ¨¡å¼ (æŒç»­åŒå‘æ³¢åŠ¨)
                    if (trendCount <= 0 || Math.random() < 0.2) {
                        trendDirection = Math.random() > 0.5 ? 1 : -1;
                        trendCount = 3 + Math.floor(Math.random() * 4);
                    }
                    changePercent = trendDirection * (0.03 + Math.random() * 0.04);
                    trendCount--;
                    break;
                
                case 'cycle':
                    // å‘¨æœŸå¾ªç¯æ¨¡å¼ (æ¨¡æ‹Ÿå¸‚åœºå‘¨æœŸ)
                    const cyclePosition = (Date.now() / 60000) % 100 / 100; // æ¯åˆ†é’Ÿä¸€ä¸ªå‘¨æœŸ
                    changePercent = Math.sin(cyclePosition * Math.PI * 2) * 0.05;
                    break;
                
                case 'pump-dump':
                    // æ‹‰ç›˜ç ¸ç›˜æ¨¡å¼
                    if (Math.random() < 0.3) {
                        changePercent = (Math.random() * 0.3); // 30%å‡ ç‡å¤§å¹…ä¸Šæ¶¨
                    } else if (Math.random() < 0.2) {
                        changePercent = -(Math.random() * 0.4); // 20%å‡ ç‡å¤§å¹…ä¸‹è·Œ
                    } else {
                        changePercent = (Math.random() * 0.1 - 0.05); // å…¶ä½™æ—¶é—´å°å¹…æ³¢åŠ¨
                    }
                    break;
                
                case 'whale':
                    // é²¸é±¼æ“çºµæ¨¡å¼
                    if (Math.random() < 0.1) {
                        // 10%å‡ ç‡é²¸é±¼æ“ä½œ
                        if (Math.random() > 0.5) {
                            // é²¸é±¼ä¹°å…¥
                            changePercent = (0.1 + Math.random() * 0.2);
                            dailyVolume += totalSupply * currentPrice * 0.3;
                        } else {
                            // é²¸é±¼å–å‡º
                            changePercent = -(0.15 + Math.random() * 0.25);
                            dailyVolume += totalSupply * currentPrice * 0.4;
                        }
                    } else {
                        changePercent = (Math.random() * 0.05 - 0.025);
                    }
                    break;
                
                case 'rollercoaster':
                    // è·Œå®•èµ·ä¼æ¨¡å¼
                    const phases = [
                        () => 0.15 + Math.random() * 0.1,  // å¿«é€Ÿä¸Šæ¶¨
                        () => -0.2 - Math.random() * 0.15, // æ€¥é€Ÿä¸‹è·Œ
                        () => 0.05 + Math.random() * 0.05, // ç¼“æ…¢å›å‡
                        () => -0.1 - Math.random() * 0.05  // å†æ¬¡å›è½
                    ];
                    
                    changePercent = phases[rollercoasterPhase % phases.length]();
                    rollercoasterPhase++;
                    break;
                
                case 'market-maker':
                    // åšå¸‚å•†æ¨¡å¼ - ç»´æŒå¸‚åœºæµåŠ¨æ€§
                    const spread = parseFloat(document.getElementById('maker-spread').value) / 100 / 2;
                    const targetPrice = (supportLevel + resistanceLevel) / 2;
                    
                    if (currentPrice > targetPrice * (1 + spread)) {
                        changePercent = -0.01;
                    } else if (currentPrice < targetPrice * (1 - spread)) {
                        changePercent = 0.01;
                    } else {
                        changePercent = (Math.random() * 0.02 - 0.01);
                    }
                    
                    // éšæœºæ·»åŠ ä¹°å–è®¢å•
                    if (Math.random() < 0.3) {
                        const volume = parseFloat(document.getElementById('maker-volume').value);
                        if (Math.random() > 0.5) {
                            addOrderToBook('buy', volume, currentPrice * (1 - spread), 'limit');
                        } else {
                            addOrderToBook('sell', volume, currentPrice * (1 + spread), 'limit');
                        }
                    }
                    break;
                
                default:
                    changePercent = (Math.random() * 0.1 - 0.05);
            }
            
            // ç‰›å¸‚/ç†Šå¸‚æ•ˆåº”
            if (isBullMarket) {
                changePercent = Math.abs(changePercent) * (1 + Math.random());
            } else if (isBearMarket) {
                changePercent = -Math.abs(changePercent) * (1 + Math.random());
            }
            
            // æ”¯æ’‘ä½å’Œé˜»åŠ›ä½æ•ˆåº”
            if (currentPrice < supportLevel * 1.05) {
                // æ¥è¿‘æ”¯æ’‘ä½ï¼Œä¸‹è·Œå¯èƒ½æ€§é™ä½
                changePercent = Math.max(changePercent, -0.01);
                // 30%å‡ ç‡åå¼¹
                if(Math.random() > 0.7) changePercent = Math.abs(changePercent);
            }
            
            if (currentPrice > resistanceLevel * 0.95) {
                // æ¥è¿‘é˜»åŠ›ä½ï¼Œä¸Šæ¶¨å¯èƒ½æ€§é™ä½
                changePercent = Math.min(changePercent, 0.01);
                // 30%å‡ ç‡å›è°ƒ
                if(Math.random() > 0.7) changePercent = -Math.abs(changePercent);
            }
            
            // å¸‚åœºæƒ…ç»ªæ•ˆåº”
            changePercent += (marketSentiment - 50) / 5000;
            
            changePrice(changePercent, 'auto');
        }
        
        // æ‰§è¡Œäº¤æ˜“
        function executeTrade(amount, type) {
            if(isTradingHalted) {
                showNotification("å¸‚åœºæš‚åœäº¤æ˜“ä¸­ï¼Œæ— æ³•æ‰§è¡Œäº¤æ˜“", "error");
                return false;
            }
            
            if (amount <= 0) {
                showNotification('äº¤æ˜“æ•°é‡å¿…é¡»å¤§äº0', 'error');
                return false;
            }
            
            if (type === 'sell' && amount > userCoins) {
                showNotification('å–å‡ºæ•°é‡ä¸èƒ½è¶…è¿‡æŒä»“é‡', 'error');
                return false;
            }
            
            if (type === 'buy' && amount * currentPrice > userCash) {
                showNotification('ç°é‡‘ä½™é¢ä¸è¶³', 'error');
                return false;
            }
            
            // è®¡ç®—å¸‚åœºå½±å“å¹¶è°ƒæ•´ä»·æ ¼
            const impact = calculateMarketImpact(amount, type);
            const priceChange = changePrice(impact, 'trade');
            
            // æ›´æ–°ç”¨æˆ·èµ„äº§
            if (type === 'buy') {
                userCash -= amount * currentPrice;
                userCoins += amount;
            } else {
                userCash += amount * currentPrice;
                userCoins -= amount;
            }
            
            // è®°å½•äº¤æ˜“
            const transaction = {
                type: type,
                amount: amount,
                price: currentPrice,
                total: amount * currentPrice,
                time: new Date().toLocaleTimeString(),
                impact: priceChange
            };
            transactions.unshift(transaction);
            
            // æ›´æ–°æ˜¾ç¤º
            updateUserBalance();
            updateTradeForms();
            updateTransactionHistory();
            
            return true;
        }
        
        // æ æ†äº¤æ˜“
        function executeLeveragedTrade(amount, type) {
            if(userLeverage <= 1) {
                executeTrade(amount, type);
                return;
            }
            
            const cost = amount * currentPrice;
            const margin = cost / userLeverage;
            
            if(margin > userCash) {
                showNotification(`ä¿è¯é‡‘ä¸è¶³ï¼éœ€è¦ ${margin.toFixed(2)} å…ƒä½œä¸ºä¿è¯é‡‘`, 'error');
                return false;
            }
            
            // è®°å½•æ æ†ä»“ä½
            leveragedPositions.push({
                type: type,
                amount: amount,
                entryPrice: currentPrice,
                margin: margin,
                liquidationPrice: type === 'buy' 
                    ? currentPrice * (1 - 0.8/userLeverage)  // å¤šä»“å¼ºå¹³ä»·
                    : currentPrice * (1 + 0.8/userLeverage)  // ç©ºä»“å¼ºå¹³ä»·
            });
            
            // å†»ç»“ä¿è¯é‡‘
            userCash -= margin;
            
            // æ‰§è¡Œäº¤æ˜“ï¼ˆä½¿ç”¨å…¨æ æ†é‡‘é¢ï¼‰
            return executeTrade(amount * userLeverage, type);
        }
        
        // æ£€æŸ¥æ æ†ä»“ä½
        function checkLeveragedPositions() {
            leveragedPositions.forEach((position, index) => {
                // æ£€æŸ¥æ˜¯å¦è§¦å‘å¼ºå¹³
                if((position.type === 'buy' && currentPrice <= position.liquidationPrice) ||
                   (position.type === 'sell' && currentPrice >= position.liquidationPrice)) {
                    // å¼ºåˆ¶å¹³ä»“
                    showNotification(`æ æ†ä»“ä½è§¦å‘å¼ºå¹³ï¼æŸå¤±ä¿è¯é‡‘ ${position.margin.toFixed(2)} å…ƒ`, 'error');
                    leveragedPositions.splice(index, 1);
                    
                    // å¹³ä»“å¤„ç†
                    if(position.type === 'buy') {
                        userCoins -= position.amount * userLeverage;
                    } else {
                        userCoins += position.amount * userLeverage;
                    }
                    
                    updateUserBalance();
                }
            });
        }
        
        // æ›´æ–°äº¤æ˜“è®°å½•
        function updateTransactionHistory() {
            const container = document.getElementById('transaction-history');
            container.innerHTML = '';
            
            transactions.slice(0, 50).forEach(tx => {
                const txElement = document.createElement('div');
                txElement.className = `transaction-item transaction-${tx.type}`;
                
                const typeText = tx.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º';
                const impactText = tx.impact >= 0 ? 
                    `(+${(tx.impact * 100).toFixed(2)}%)` : 
                    `(${(tx.impact * 100).toFixed(2)}%)`;
                
                txElement.innerHTML = `
                    <span>${tx.time} ${typeText} ${tx.amount.toFixed(2)} å¸</span>
                    <span>@ ${tx.price.toFixed(2)} å…ƒ ${impactText}</span>
                `;
                
                container.appendChild(txElement);
            });
        }
        
        // å¯åŠ¨/åœæ­¢è‡ªåŠ¨æ³¢åŠ¨
        function toggleAutoFluctuation() {
            const button = document.getElementById('toggleAuto');
            if (autoIntervalId) {
                clearInterval(autoIntervalId);
                autoIntervalId = null;
                button.textContent = 'å¯åŠ¨è‡ªåŠ¨æ³¢åŠ¨';
                button.className = 'btn btn-primary';
                showNotification("è‡ªåŠ¨æ³¢åŠ¨å·²åœæ­¢", "info");
            } else {
                const interval = parseInt(document.getElementById('autoInterval').value) * 1000;
                currentMode = document.getElementById('autoMode').value;
                autoIntervalId = setInterval(randomFluctuation, interval);
                button.textContent = 'åœæ­¢è‡ªåŠ¨æ³¢åŠ¨';
                button.className = 'btn btn-warning';
                showNotification(`è‡ªåŠ¨æ³¢åŠ¨å·²å¯åŠ¨ (${currentMode}æ¨¡å¼)`, "success");
            }
        }
        
        // æ¨¡æ‹Ÿé²¸é±¼ä¹°å…¥
        function whaleBuy() {
            const amount = totalSupply * 0.01; // é²¸é±¼ä¹°å…¥æ€»ä¾›åº”é‡çš„1%
            executeTrade(amount, 'buy');
            showNotification(`é²¸é±¼ä¹°å…¥ ${amount.toFixed(2)} æ³¢åŠ¨å¸ï¼Œä»·æ ¼è¢«æ¨é«˜ï¼`, "info");
        }
        
        // æ¨¡æ‹Ÿé²¸é±¼å–å‡º
        function whaleSell() {
            const amount = totalSupply * 0.01; // é²¸é±¼å–å‡ºæ€»ä¾›åº”é‡çš„1%
            executeTrade(amount, 'sell');
            showNotification(`é²¸é±¼å–å‡º ${amount.toFixed(2)} æ³¢åŠ¨å¸ï¼Œä»·æ ¼è¢«å‹ä½ï¼`, "info");
        }
        
        // æ¨¡æ‹Ÿæ‹‰ç›˜è¡ŒåŠ¨
        function pumpAction() {
            changePrice(0.30, 'manual');
            dailyVolume += totalSupply * currentPrice * 0.5;
            showNotification("å¸‚åœºå‡ºç°æ‹‰ç›˜è¡ŒåŠ¨ï¼Œä»·æ ¼å¿«é€Ÿä¸Šæ¶¨30%ï¼", "info");
        }
        
        // æ¨¡æ‹Ÿç ¸ç›˜è¡ŒåŠ¨
        function dumpAction() {
            changePrice(-0.40, 'manual');
            dailyVolume += totalSupply * currentPrice * 0.6;
            showNotification("å¸‚åœºå‡ºç°ç ¸ç›˜è¡ŒåŠ¨ï¼Œä»·æ ¼æš´è·Œ40%ï¼", "info");
        }
        
        // æ¨¡æ‹Ÿåˆ©å¥½æ¶ˆæ¯
        function goodNews() {
            changePrice(0.15, 'manual');
            dailyVolume += totalSupply * currentPrice * 0.3;
            showNotification("å¸‚åœºä¼ å‡ºåˆ©å¥½æ¶ˆæ¯ï¼Œä»·æ ¼ä¸Šæ¶¨15%ï¼", "info");
        }
        
        // æ¨¡æ‹Ÿåˆ©ç©ºæ¶ˆæ¯
        function badNews() {
            changePrice(-0.18, 'manual');
            dailyVolume += totalSupply * currentPrice * 0.4;
            showNotification("å¸‚åœºä¼ å‡ºåˆ©ç©ºæ¶ˆæ¯ï¼Œä»·æ ¼ä¸‹è·Œ18%ï¼", "info");
        }
        
        // æ¨¡æ‹Ÿäº¤æ˜“æ‰€è¢«ç›—
        function exchangeHack() {
            changePrice(-0.25, 'manual');
            dailyVolume += totalSupply * currentPrice * 0.7;
            showNotification("äº¤æ˜“æ‰€å®£å¸ƒè¢«ç›—ï¼Œå¸‚åœºææ…Œæ€§æŠ›å”®ï¼Œä»·æ ¼ä¸‹è·Œ25%ï¼", "error");
        }
        
        // æ¨¡æ‹Ÿç›‘ç®¡æ¶ˆæ¯
        function regulatoryNews() {
            const change = Math.random() > 0.5 ? 0.20 : -0.20;
            changePrice(change, 'manual');
            dailyVolume += totalSupply * currentPrice * 0.5;
            showNotification(`ç›‘ç®¡æ¶ˆæ¯å‘å¸ƒï¼Œä»·æ ¼${change > 0 ? 'ä¸Šæ¶¨' : 'ä¸‹è·Œ'}${Math.abs(change)*100}%ï¼`, "info");
        }
        
        // å¯åŠ¨ç‰›å¸‚å‘¨æœŸ
        function startBullMarket() {
            isBullMarket = true;
            isBearMarket = false;
            showNotification("ç‰›å¸‚å‘¨æœŸå¼€å§‹ï¼Œå¸‚åœºæƒ…ç»ªä¹è§‚ï¼", "success");
        }
        
        // å¯åŠ¨ç†Šå¸‚å‘¨æœŸ
        function startBearMarket() {
            isBearMarket = true;
            isBullMarket = false;
            showNotification("ç†Šå¸‚å‘¨æœŸå¼€å§‹ï¼Œå¸‚åœºæƒ…ç»ªæ‚²è§‚ï¼", "warning");
        }
        
        // æ¨¡æ‹Ÿå¸ç­¹é˜¶æ®µ
        function accumulationPhase() {
            currentMode = 'sideways';
            if (!autoIntervalId) randomFluctuation();
            showNotification("å¸‚åœºè¿›å…¥å¸ç­¹é˜¶æ®µï¼Œä»·æ ¼çª„å¹…éœ‡è¡", "info");
        }
        
        // æ¨¡æ‹Ÿæ´¾å‘é˜¶æ®µ
        function distributionPhase() {
            currentMode = 'volatile';
            if (!autoIntervalId) randomFluctuation();
            showNotification("å¸‚åœºè¿›å…¥æ´¾å‘é˜¶æ®µï¼Œä»·æ ¼å‰§çƒˆæ³¢åŠ¨", "info");
        }
        
        // è·Œå®•èµ·ä¼æ¨¡å¼
        function startRollercoaster() {
            currentMode = 'rollercoaster';
            rollercoasterPhase = 0;
            if (!autoIntervalId) {
                const interval = parseInt(document.getElementById('autoInterval').value) * 1000;
                autoIntervalId = setInterval(randomFluctuation, interval);
                document.getElementById('toggleAuto').textContent = 'åœæ­¢è‡ªåŠ¨æ³¢åŠ¨';
                document.getElementById('toggleAuto').className = 'btn btn-warning';
            }
            showNotification("å¯åŠ¨è·Œå®•èµ·ä¼æ¨¡å¼ï¼å¸‚åœºå°†ç»å†å‰§çƒˆæ³¢åŠ¨å‘¨æœŸ", "info");
        }
        
        // æ”¿åºœæ•‘å¸‚
        function marketRescue() {
            changePrice(0.25, 'manual');
            dailyVolume += totalSupply * currentPrice * 0.8;
            showNotification("æ”¿åºœå®£å¸ƒæ•‘å¸‚æªæ–½ï¼Œä»·æ ¼å¼ºåŠ›åå¼¹25%ï¼", "success");
        }
        
        // æœºæ„æŠ¤ç›˜
        function institutionalBuy() {
            changePrice(0.15, 'manual');
            dailyVolume += totalSupply * currentPrice * 0.6;
            showNotification("å¤§å‹æœºæ„å…¥åœºæŠ¤ç›˜ï¼Œä»·æ ¼ä¸Šæ¶¨15%ï¼", "info");
        }
        
        // ç†”æ–­æœºåˆ¶
        function triggerCircuitBreaker() {
            isTradingHalted = !isTradingHalted;
            if(isTradingHalted) {
                showNotification("è§¦å‘ç†”æ–­æœºåˆ¶ï¼Œå¸‚åœºæš‚åœäº¤æ˜“ï¼", "error");
                document.getElementById('price-change').textContent = "(æš‚åœäº¤æ˜“)";
                document.getElementById('price-change').className = 'price-change';
            } else {
                showNotification("å¸‚åœºæ¢å¤äº¤æ˜“", "success");
                updatePriceDisplay(currentPrice, currentPrice);
            }
        }
        
        // å¼ºåˆ¶å¹³ä»“æ¨¡æ‹Ÿ
        function simulateStopOut() {
            if(leveragedPositions.length === 0) {
                showNotification("æ²¡æœ‰æ æ†ä»“ä½å¯å¹³ä»“", "info");
                return;
            }
            
            // æ¨¡æ‹Ÿä»·æ ¼å‰§çƒˆæ³¢åŠ¨è§¦å‘å¼ºå¹³
            const position = leveragedPositions[0];
            const oldPrice = currentPrice;
            
            if(position.type === 'buy') {
                currentPrice = position.liquidationPrice * 0.95; // è·Œç ´å¼ºå¹³ä»·
            } else {
                currentPrice = position.liquidationPrice * 1.05; // æ¶¨ç ´å¼ºå¹³ä»·
            }
            
            updatePriceDisplay(currentPrice, oldPrice);
            showNotification(`æ¨¡æ‹Ÿä»·æ ¼å‰§çƒˆæ³¢åŠ¨ï¼Œè§¦å‘æ æ†ä»“ä½å¼ºå¹³ï¼æŸå¤±ä¿è¯é‡‘ ${position.margin.toFixed(2)} å…ƒ`, "error");
            
            // ç§»é™¤ä»“ä½
            leveragedPositions.shift();
        }
        
        // åº”ç”¨è‡ªå®šä¹‰ä»·æ ¼å˜åŒ–
        function applyCustomChange() {
            const change = parseFloat(document.getElementById('custom-change').value);
            if (isNaN(change)) {
                showNotification("è¯·è¾“å…¥æœ‰æ•ˆçš„ç™¾åˆ†æ¯”æ•°å€¼", "error");
                return;
            }
            changePrice(change/100, 'manual');
            showNotification(`åº”ç”¨è‡ªå®šä¹‰ä»·æ ¼å˜åŒ–: ${change}%`, "info");
        }
        
        // æ¨¡æ‹Ÿæ­»çŒ«åå¼¹
        function deadCatBounce() {
            changePrice(0.30, 'manual');
            setTimeout(() => {
                changePrice(-0.50, 'manual');
                showNotification("æ­»çŒ«åå¼¹æ¨¡å¼ï¼šå…ˆæ¶¨30%åè·Œ50%", "warning");
            }, 2000);
        }
        
        // æ¨¡æ‹Ÿå¤´è‚©é¡¶å½¢æ€
        function headAndShoulders() {
            // å·¦è‚©
            changePrice(0.15, 'manual');
            setTimeout(() => {
                // å¤´éƒ¨
                changePrice(-0.10, 'manual');
                setTimeout(() => {
                    changePrice(0.20, 'manual');
                    setTimeout(() => {
                        // å³è‚©
                        changePrice(-0.15, 'manual');
                        setTimeout(() => {
                            changePrice(0.10, 'manual');
                            setTimeout(() => {
                                // é¢ˆçº¿çªç ´
                                changePrice(-0.30, 'manual');
                                showNotification("å¤´è‚©é¡¶å½¢æ€å®Œæˆï¼Œä»·æ ¼è·Œç ´é¢ˆçº¿ï¼", "info");
                            }, 1000);
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 1000);
        }
        
        // æ¨¡æ‹ŸåŒåº•å½¢æ€
        function doubleBottom() {
            // ç¬¬ä¸€ä¸ªåº•
            changePrice(-0.20, 'manual');
            setTimeout(() => {
                // åå¼¹
                changePrice(0.15, 'manual');
                setTimeout(() => {
                    // ç¬¬äºŒä¸ªåº•
                    changePrice(-0.10, 'manual');
                    setTimeout(() => {
                        // çªç ´é¢ˆçº¿
                        changePrice(0.25, 'manual');
                        showNotification("åŒåº•å½¢æ€å®Œæˆï¼Œä»·æ ¼çªç ´é¢ˆçº¿ï¼", "info");
                    }, 1000);
                }, 1000);
            }, 1000);
        }
        
        // æ¨¡æ‹Ÿåˆ†å‰äº‹ä»¶
        function forkEvent() {
            const change = Math.random() > 0.5 ? 0.30 : -0.30;
            changePrice(change, 'manual');
            showNotification(`åˆ†å‰äº‹ä»¶å‘ç”Ÿï¼Œä»·æ ¼${change > 0 ? 'ä¸Šæ¶¨' : 'ä¸‹è·Œ'}30%ï¼`, "info");
        }
        
        // æ¨¡æ‹Ÿå‡åŠäº‹ä»¶
        function halvingEvent() {
            totalSupply *= 0.5; // ä¾›åº”é‡å‡åŠ
            changePrice(0.50, 'manual');
            showNotification("å‡åŠäº‹ä»¶å‘ç”Ÿï¼Œä¾›åº”é‡å‡å°‘50%ï¼Œä»·æ ¼ä¸Šæ¶¨ï¼", "success");
        }
        
        // æ¨¡æ‹Ÿç©ºæŠ•æ´»åŠ¨
        function airdropEvent() {
            const airdropAmount = userCoins * 0.1; // 10%ç©ºæŠ•
            userCoins += airdropAmount;
            changePrice(0.15, 'manual');
            showNotification(`è·å¾—${airdropAmount.toFixed(2)}æ³¢åŠ¨å¸ç©ºæŠ•ï¼Œä»·æ ¼ä¸Šæ¶¨15%ï¼`, "success");
            updateUserBalance();
        }
        
        // æ¨¡æ‹Ÿå­£èŠ‚æ€§æ•ˆåº”
        function seasonalEffect() {
            const month = new Date().getMonth();
            let change;
            
            // å†å²æ•°æ®æ˜¾ç¤ºåŠ å¯†è´§å¸é€šå¸¸åœ¨å¹´åº•è¡¨ç°è¾ƒå¥½
            if (month >= 10) { // 11-12æœˆ
                change = 0.20;
            } else if (month >= 7) { // 8-10æœˆ
                change = 0.10;
            } else if (month >= 4) { // 5-7æœˆ
                change = -0.10;
            } else { // 1-4æœˆ
                change = 0.05;
            }
            
            changePrice(change, 'manual');
            showNotification(`å­£èŠ‚æ€§æ•ˆåº”: ${getMonthName(month)}é€šå¸¸${change > 0 ? 'ä¸Šæ¶¨' : 'ä¸‹è·Œ'}`, "info");
        }
        
        // è·å–æœˆä»½åç§°
        function getMonthName(month) {
            const months = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", 
                          "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
            return months[month];
        }
        
        // æ¨¡æ‹Ÿè™šå‡æŒ‚å•
        function spoofingOrder() {
            // å¤§é‡æŒ‚å•åæ’¤å•
            const amount = totalSupply * 0.02;
            addOrderToBook(Math.random() > 0.5 ? 'buy' : 'sell', amount, 
                          currentPrice * (Math.random() > 0.5 ? 0.9 : 1.1), 'limit');
            
            setTimeout(() => {
                // æ’¤å•
                if (orderBook.bids.length > 0 || orderBook.asks.length > 0) {
                    if (Math.random() > 0.5 && orderBook.bids.length > 0) {
                        orderBook.bids.shift();
                    } else if (orderBook.asks.length > 0) {
                        orderBook.asks.shift();
                    }
                    updateOrderBook(currentPrice);
                    showNotification("æ£€æµ‹åˆ°è™šå‡æŒ‚å•è¡Œä¸ºï¼šå¤§å•è¢«æ’¤é”€", "warning");
                }
            }, 2000);
        }
        
        // æ¨¡æ‹Ÿæ´—ç›˜äº¤æ˜“
        function washTrade() {
            // åŒä¸€è´¦æˆ·ä¹°å–ç›¸åŒæ•°é‡ï¼Œåˆ¶é€ è™šå‡äº¤æ˜“é‡
            const amount = totalSupply * 0.005;
            executeTrade(amount, 'buy');
            executeTrade(amount, 'sell');
            showNotification("æ£€æµ‹åˆ°æ´—ç›˜äº¤æ˜“ï¼šåŒä¸€è´¦æˆ·ä¹°å–ç›¸åŒæ•°é‡", "warning");
        }
        
        // æ·»åŠ è®¢å•åˆ°è®¢å•ç°¿
        function addOrderToBook(side, amount, price, type) {
            const order = {
                id: Date.now(),
                side: side,
                amount: amount,
                price: price,
                type: type,
                timestamp: new Date()
            };
            
            if (side === 'buy') {
                orderBook.bids.push(order);
                // æŒ‰ä»·æ ¼ä»é«˜åˆ°ä½æ’åº
                orderBook.bids.sort((a, b) => b.price - a.price);
            } else {
                orderBook.asks.push(order);
                // æŒ‰ä»·æ ¼ä»ä½åˆ°é«˜æ’åº
                orderBook.asks.sort((a, b) => a.price - b.price);
            }
            
            // å¦‚æœæ˜¯ç”¨æˆ·è®¢å•ï¼Œè®°å½•ä¸‹æ¥
            if (type !== 'market-maker') {
                userOrders.push(order);
            }
            
            updateOrderBook(currentPrice);
            return order;
        }
        
        // æ›´æ–°è®¢å•ç°¿æ˜¾ç¤º
        function updateOrderBook(currentPrice) {
            const bidContainer = document.getElementById('bid-orders');
            const askContainer = document.getElementById('ask-orders');
            
            bidContainer.innerHTML = '';
            askContainer.innerHTML = '';
            
            // æ˜¾ç¤ºå‰10ä¸ªä¹°å•
            orderBook.bids.slice(0, 10).forEach(order => {
                const row = document.createElement('div');
                row.className = 'order-row bid';
                row.innerHTML = `
                    <span>${order.price.toFixed(4)}</span>
                    <span>${order.amount.toFixed(2)}</span>
                    <span>${(order.price * order.amount).toFixed(2)}</span>
                `;
                bidContainer.appendChild(row);
            });
            
            // æ˜¾ç¤ºå‰10ä¸ªå–å•
            orderBook.asks.slice(0, 10).forEach(order => {
                const row = document.createElement('div');
                row.className = 'order-row ask';
                row.innerHTML = `
                    <span>${order.price.toFixed(4)}</span>
                    <span>${order.amount.toFixed(2)}</span>
                    <span>${(order.price * order.amount).toFixed(2)}</span>
                `;
                askContainer.appendChild(row);
            });
            
            // æ›´æ–°æ·±åº¦å›¾
            updateDepthChart();
        }
        
        // æ›´æ–°æ·±åº¦å›¾
        function updateDepthChart() {
            if (!depthChart) return;
            
            // è®¡ç®—ç´¯è®¡æ·±åº¦
            const bids = orderBook.bids.slice(0, 10);
            const asks = orderBook.asks.slice(0, 10);
            
            let bidTotal = 0;
            let askTotal = 0;
            
            const bidData = bids.map(order => {
                bidTotal += order.amount;
                return bidTotal;
            });
            
            const askData = asks.map(order => {
                askTotal += order.amount;
                return askTotal;
            });
            
            const bidLabels = bids.map(order => order.price.toFixed(4));
            const askLabels = asks.map(order => order.price.toFixed(4));
            
            depthChart.data.labels = [...bidLabels.reverse(), ...askLabels];
            depthChart.data.datasets[0].data = [...bidData.reverse(), ...Array(askData.length).fill(0)];
            depthChart.data.datasets[1].data = [...Array(bidData.length).fill(0), ...askData];
            
            depthChart.update();
        }
        
        // æ£€æŸ¥æ­¢æŸæ­¢ç›ˆè®¢å•
        function checkStopOrders(currentPrice) {
            userOrders.forEach((order, index) => {
                if (order.type === 'stop' || order.type === 'stop-limit') {
                    if ((order.side === 'sell' && currentPrice <= order.stopPrice) ||
                        (order.side === 'buy' && currentPrice >= order.stopPrice)) {
                        
                        // è§¦å‘æ­¢æŸ/æ­¢ç›ˆ
                        if (order.type === 'stop') {
                            // å¸‚ä»·å•
                            executeTrade(order.amount, order.side);
                            showNotification(`æ­¢æŸ/æ­¢ç›ˆè®¢å•è§¦å‘: ${order.side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'} ${order.amount} å¸`, "info");
                        } else {
                            // é™ä»·å•
                            addOrderToBook(order.side, order.amount, order.price, 'limit');
                            showNotification(`æ­¢æŸé™ä»·å•è§¦å‘: ${order.side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'} ${order.amount} å¸ @ ${order.price}`, "info");
                        }
                        
                        userOrders.splice(index, 1);
                    }
                }
            });
        }
        
        // æäº¤è®¢å•
        function placeOrder() {
            const type = document.getElementById('place-order-type').value;
            const side = document.getElementById('place-order-side').value;
            const amount = parseFloat(document.getElementById('place-order-amount').value);
            const price = parseFloat(document.getElementById('place-order-price').value);
            const stopPrice = parseFloat(document.getElementById('place-order-stop-price').value);
            
            if (amount <= 0) {
                showNotification("è®¢å•æ•°é‡å¿…é¡»å¤§äº0", "error");
                return;
            }
            
            if ((type === 'limit' || type === 'stop-limit') && price <= 0) {
                showNotification("é™ä»·å¿…é¡»å¤§äº0", "error");
                return;
            }
            
            if ((type === 'stop' || type === 'stop-limit') && stopPrice <= 0) {
                showNotification("è§¦å‘ä»·æ ¼å¿…é¡»å¤§äº0", "error");
                return;
            }
            
            let order;
            if (type === 'market') {
                // å¸‚ä»·å•ç«‹å³æ‰§è¡Œ
                executeTrade(amount, side);
                showNotification(`å¸‚ä»·å•æ‰§è¡Œ: ${side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'} ${amount} å¸`, "success");
            } else if (type === 'limit') {
                // é™ä»·å•åŠ å…¥è®¢å•ç°¿
                order = addOrderToBook(side, amount, price, 'limit');
                showNotification(`é™ä»·å•å·²æäº¤: ${side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'} ${amount} å¸ @ ${price}`, "success");
            } else if (type === 'stop') {
                // æ­¢æŸå•è®°å½•ç­‰å¾…è§¦å‘
                userOrders.push({
                    id: Date.now(),
                    side: side,
                    amount: amount,
                    stopPrice: stopPrice,
                    type: 'stop',
                    timestamp: new Date()
                });
                showNotification(`æ­¢æŸå•å·²è®¾ç½®: å½“ä»·æ ¼${side === 'buy' ? '>=' : '<='} ${stopPrice} æ—¶${side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'} ${amount} å¸`, "success");
            } else if (type === 'stop-limit') {
                // æ­¢æŸé™ä»·å•è®°å½•ç­‰å¾…è§¦å‘
                userOrders.push({
                    id: Date.now(),
                    side: side,
                    amount: amount,
                    price: price,
                    stopPrice: stopPrice,
                    type: 'stop-limit',
                    timestamp: new Date()
                });
                showNotification(`æ­¢æŸé™ä»·å•å·²è®¾ç½®: å½“ä»·æ ¼${side === 'buy' ? '>=' : '<='} ${stopPrice} æ—¶${side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'} ${amount} å¸ @ ${price}`, "success");
            } else if (type === 'iceberg') {
                // å†°å±±è®¢å• - æ‹†åˆ†ä¸ºå¤šä¸ªå°è®¢å•
                const chunkSize = amount / 5;
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        addOrderToBook(side, chunkSize, price, 'limit');
                    }, i * 1000);
                }
                showNotification(`å†°å±±è®¢å•å·²æäº¤: å°†${amount} å¸æ‹†åˆ†ä¸º5ä¸ªå°å• ${side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'} @ ${price}`, "success");
            }
        }
        
        // æ’¤é”€æ‰€æœ‰è®¢å•
        function cancelAllOrders() {
            orderBook.bids = orderBook.bids.filter(order => {
                return !userOrders.some(userOrder => userOrder.id === order.id);
            });
            
            orderBook.asks = orderBook.asks.filter(order => {
                return !userOrders.some(userOrder => userOrder.id === order.id);
            });
            
            userOrders = [];
            updateOrderBook(currentPrice);
            showNotification("æ‰€æœ‰è®¢å•å·²æ’¤é”€", "info");
        }
        
        // ç”Ÿæˆéšæœºæ–°é—»
        function generateRandomNews() {
            const newsTypes = [
                {
                    type: 'positive',
                    titles: [
                        "å¤§å‹æœºæ„å®£å¸ƒæŠ•èµ„æ³¢åŠ¨å¸",
                        "æ³¢åŠ¨å¸è¢«åˆ—å…¥ä¸»è¦äº¤æ˜“æ‰€",
                        "æ³¢åŠ¨å¸æŠ€æœ¯å‡çº§æˆåŠŸå®Œæˆ",
                        "çŸ¥åäººå£«æ”¯æŒæ³¢åŠ¨å¸",
                        "æ³¢åŠ¨å¸ç”Ÿæ€ç³»ç»Ÿæ‰©å±•"
                    ],
                    impact: 0.05
                },
                {
                    type: 'negative',
                    titles: [
                        "ç›‘ç®¡æœºæ„è°ƒæŸ¥æ³¢åŠ¨å¸",
                        "æ³¢åŠ¨å¸ç½‘ç»œå‡ºç°å»¶è¿Ÿ",
                        "äº¤æ˜“æ‰€æš‚åœæ³¢åŠ¨å¸æç°",
                        "æ³¢åŠ¨å¸å¼€å‘å›¢é˜Ÿåˆ†æ­§",
                        "å®‰å…¨æ¼æ´å½±å“æ³¢åŠ¨å¸é’±åŒ…"
                    ],
                    impact: -0.05
                },
                {
                    type: 'neutral',
                    titles: [
                        "æ³¢åŠ¨å¸ä»·æ ¼æ³¢åŠ¨åŠ å‰§",
                        "åˆ†æå¸ˆå¯¹æ³¢åŠ¨å¸çœ‹æ³•åˆ†æ­§",
                        "æ³¢åŠ¨å¸ç¤¾åŒºå¤§ä¼šå³å°†ä¸¾è¡Œ",
                        "æ³¢åŠ¨å¸ç½‘ç»œå‡çº§è®¡åˆ’å…¬å¸ƒ",
                        "æ³¢åŠ¨å¸äº¤æ˜“é‡åˆ›æ–°é«˜"
                    ],
                    impact: 0
                }
            ];
            
            const newsType = newsTypes[Math.floor(Math.random() * newsTypes.length)];
            const title = newsType.titles[Math.floor(Math.random() * newsType.titles.length)];
            
            addNews(title, newsType.type, newsType.impact);
        }
        
        // æ·»åŠ æ–°é—»
        function addNews(title, sentiment, impact) {
            const container = document.getElementById('news-container');
            const newsItem = document.createElement('div');
            newsItem.className = `news-item news-${sentiment}`;
            
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            newsItem.innerHTML = `
                <div class="news-time">${timeStr}</div>
                <div class="news-content">${title}</div>
            `;
            
            container.insertBefore(newsItem, container.firstChild);
            
            // é™åˆ¶æ–°é—»æ•°é‡
            if (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
            
            // æ–°é—»å½±å“å¸‚åœº
            if (impact !== 0) {
                changePrice(impact + (Math.random() * 0.02 - 0.01), 'news');
            }
        }
        
        // æ¸…ç©ºæ–°é—»
        function clearNews() {
            document.getElementById('news-container').innerHTML = '';
            showNotification("æ‰€æœ‰æ–°é—»å·²æ¸…ç©º", "info");
        }
        
        // æäº¤è‡ªå®šä¹‰æ–°é—»
        function submitCustomNews() {
            const content = document.getElementById('custom-news').value;
            const sentiment = document.getElementById('news-sentiment').value;
            
            if (!content) {
                showNotification("è¯·è¾“å…¥æ–°é—»å†…å®¹", "error");
                return;
            }
            
            let impact = 0;
            if (sentiment === 'positive') impact = 0.05;
            if (sentiment === 'negative') impact = -0.05;
            
            addNews(content, sentiment, impact);
            document.getElementById('custom-news').value = '';
            showNotification("è‡ªå®šä¹‰æ–°é—»å·²å‘å¸ƒ", "success");
        }
        
        // æ¿€æ´»äº¤æ˜“ç­–ç•¥
        function activateStrategy() {
            const strategyType = document.getElementById('strategy-select').value;
            
            if (activeStrategy) {
                showNotification(`å·²æœ‰æ¿€æ´»ç­–ç•¥: ${activeStrategy}`, "error");
                return;
            }
            
            let strategyName = '';
            let params = {};
            
            switch(strategyType) {
                case 'mean-reversion':
                    strategyName = 'å‡å€¼å›å½’ç­–ç•¥';
                    params.period = parseInt(document.getElementById('mr-period').value);
                    params.deviation = parseFloat(document.getElementById('mr-deviation').value);
                    break;
                    
                case 'momentum':
                    strategyName = 'åŠ¨é‡ç­–ç•¥';
                    params.period = parseInt(document.getElementById('momentum-period').value);
                    params.threshold = parseFloat(document.getElementById('momentum-threshold').value);
                    break;
                    
                case 'grid':
                    strategyName = 'ç½‘æ ¼äº¤æ˜“ç­–ç•¥';
                    params.upper = parseFloat(document.getElementById('grid-upper').value);
                    params.lower = parseFloat(document.getElementById('grid-lower').value);
                    params.levels = parseInt(document.getElementById('grid-levels').value);
                    break;
                    
                case 'custom':
                    strategyName = 'è‡ªå®šä¹‰ç­–ç•¥';
                    // è‡ªå®šä¹‰ç­–ç•¥å‚æ•°
                    break;
                    
                default:
                    strategyName = 'åŸºæœ¬ç­–ç•¥';
            }
            
            activeStrategy = strategyType;
            strategyTrades = 0;
            strategyProfit = 0;
            
            document.getElementById('active-strategy-name').textContent = strategyName;
            document.getElementById('strategy-trades').textContent = '0';
            document.getElementById('strategy-pnl').textContent = '0.00 å…ƒ';
            document.getElementById('strategy-status').style.display = 'block';
            
            showNotification(`ç­–ç•¥æ¿€æ´»: ${strategyName}`, "success");
            
            // å¼€å§‹ç­–ç•¥æ‰§è¡Œ
            const capitalPercent = parseInt(document.getElementById('strategy-capital').value) / 100;
            const strategyInterval = setInterval(() => {
                if (!activeStrategy) {
                    clearInterval(strategyInterval);
                    return;
                }
                
                executeStrategy(strategyType, params, capitalPercent);
            }, 5000);
        }
        
        // æ‰§è¡Œç­–ç•¥
        function executeStrategy(type, params, capitalPercent) {
            if (isTradingHalted) return;
            
            let shouldBuy = false;
            let shouldSell = false;
            
            switch(type) {
                case 'mean-reversion':
                    // å‡å€¼å›å½’ç­–ç•¥
                    if (priceHistory.length < params.period) return;
                    
                    const recentPrices = priceHistory.slice(-params.period);
                    const mean = recentPrices.reduce((a, b) => a + b, 0) / params.period;
                    const std = Math.sqrt(recentPrices.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / params.period);
                    
                    const zScore = (currentPrice - mean) / std;
                    
                    if (zScore > params.deviation) {
                        shouldSell = true;
                    } else if (zScore < -params.deviation) {
                        shouldBuy = true;
                    }
                    break;
                    
                case 'momentum':
                    // åŠ¨é‡ç­–ç•¥
                    if (priceHistory.length < params.period) return;
                    
                    const pastPrice = priceHistory[priceHistory.length - params.period];
                    const momentum = (currentPrice - pastPrice) / pastPrice * 100;
                    
                    if (momentum > params.threshold) {
                        shouldBuy = true;
                    } else if (momentum < -params.threshold) {
                        shouldSell = true;
                    }
                    break;
                    
                case 'grid':
                    // ç½‘æ ¼äº¤æ˜“ç­–ç•¥
                    const gridSize = (params.upper - params.lower) / params.levels;
                    const position = Math.floor((currentPrice - params.lower) / gridSize);
                    
                    if (position <= 0) {
                        shouldBuy = true;
                    } else if (position >= params.levels) {
                        shouldSell = true;
                    } else {
                        // ç½‘æ ¼ä¸­é—´ä½ç½®ï¼Œæ ¹æ®å½“å‰æŒä»“å†³å®š
                        if (userCoins < totalSupply * 0.01) {
                            shouldBuy = true;
                        } else if (userCoins > totalSupply * 0.02) {
                            shouldSell = true;
                        }
                    }
                    break;
                    
                case 'arbitrage':
                    // å¥—åˆ©ç­–ç•¥ (ç®€åŒ–ç‰ˆ)
                    if (orderBook.bids.length > 0 && orderBook.asks.length > 0) {
                        const bestBid = orderBook.bids[0].price;
                        const bestAsk = orderBook.asks[0].price;
                        
                        if (bestBid > bestAsk) {
                            // å¼‚å¸¸æƒ…å†µï¼Œç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿ
                            shouldBuy = true;
                            shouldSell = true;
                        } else if ((bestAsk - bestBid) / bestBid > 0.02) {
                            // ä»·å·®å¤§äº2%ï¼Œå¯èƒ½æœ‰æœºä¼š
                            shouldBuy = true;
                            setTimeout(() => shouldSell = true, 1000);
                        }
                    }
                    break;
                    
                case 'martingale':
                    // é©¬ä¸æ ¼å°”ç­–ç•¥ (é«˜é£é™©)
                    if (transactions.length > 0) {
                        const lastTx = transactions[0];
                        if (lastTx.type === 'buy' && lastTx.price * 0.95 > currentPrice) {
                            // äºæŸæ—¶åŠ å€ä¹°å…¥
                            shouldBuy = true;
                        } else if (lastTx.type === 'sell' && lastTx.price * 1.05 < currentPrice) {
                            // äºæŸæ—¶åŠ å€å–å‡º
                            shouldSell = true;
                        }
                    }
                    break;
                    
                case 'dca':
                    // å®šæŠ•ç­–ç•¥
                    shouldBuy = true;
                    break;
            }
            
            // æ‰§è¡Œäº¤æ˜“
            const amount = Math.max(0.01, (userCash * capitalPercent / currentPrice).toFixed(2));
            
            if (shouldBuy && userCash > amount * currentPrice) {
                if (executeTrade(amount, 'buy')) {
                    strategyTrades++;
                    showNotification(`ç­–ç•¥æ‰§è¡Œ: ä¹°å…¥ ${amount} æ³¢åŠ¨å¸`, "info");
                }
            } else if (shouldSell && userCoins > amount) {
                if (executeTrade(amount, 'sell')) {
                    strategyTrades++;
                    showNotification(`ç­–ç•¥æ‰§è¡Œ: å–å‡º ${amount} æ³¢åŠ¨å¸`, "info");
                }
            }
            
            // æ›´æ–°ç­–ç•¥çŠ¶æ€
            document.getElementById('strategy-trades').textContent = strategyTrades;
            document.getElementById('strategy-pnl').textContent = (userCash + userCoins * currentPrice - 100000).toFixed(2) + ' å…ƒ';
        }
        
        // åœæ­¢ç­–ç•¥
        function stopStrategy() {
            if (!activeStrategy) {
                showNotification("æ²¡æœ‰æ¿€æ´»çš„ç­–ç•¥", "info");
                return;
            }
            
            activeStrategy = null;
            document.getElementById('strategy-status').style.display = 'none';
            showNotification("äº¤æ˜“ç­–ç•¥å·²åœæ­¢", "info");
        }
        
        // å›æµ‹ç­–ç•¥
        function backtestStrategy() {
            const strategyType = document.getElementById('strategy-select').value;
            let params = {};
            let strategyName = '';
            
            switch(strategyType) {
                case 'mean-reversion':
                    strategyName = 'å‡å€¼å›å½’ç­–ç•¥';
                    params.period = parseInt(document.getElementById('mr-period').value);
                    params.deviation = parseFloat(document.getElementById('mr-deviation').value);
                    break;
                    
                case 'momentum':
                    strategyName = 'åŠ¨é‡ç­–ç•¥';
                    params.period = parseInt(document.getElementById('momentum-period').value);
                    params.threshold = parseFloat(document.getElementById('momentum-threshold').value);
                    break;
                    
                case 'grid':
                    strategyName = 'ç½‘æ ¼äº¤æ˜“ç­–ç•¥';
                    params.upper = parseFloat(document.getElementById('grid-upper').value);
                    params.lower = parseFloat(document.getElementById('grid-lower').value);
                    params.levels = parseInt(document.getElementById('grid-levels').value);
                    break;
                    
                default:
                    strategyName = 'åŸºæœ¬ç­–ç•¥';
            }
            
            // ç®€åŒ–å›æµ‹ - å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨æ›´å¤æ‚çš„æ–¹æ³•
            let balance = 100000;
            let coins = 0;
            let trades = 0;
            
            for (let i = params.period || 10; i < priceHistory.length; i++) {
                const currentPrice = priceHistory[i];
                const pastPrices = priceHistory.slice(i - (params.period || 10), i);
                
                let shouldBuy = false;
                let shouldSell = false;
                
                switch(strategyType) {
                    case 'mean-reversion':
                        const mean = pastPrices.reduce((a, b) => a + b, 0) / pastPrices.length;
                        const std = Math.sqrt(pastPrices.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / pastPrices.length);
                        const zScore = (currentPrice - mean) / std;
                        
                        if (zScore > params.deviation) shouldSell = true;
                        if (zScore < -params.deviation) shouldBuy = true;
                        break;
                        
                    case 'momentum':
                        const pastPrice = pastPrices[0];
                        const momentum = (currentPrice - pastPrice) / pastPrice * 100;
                        
                        if (momentum > params.threshold) shouldBuy = true;
                        if (momentum < -params.threshold) shouldSell = true;
                        break;
                        
                    case 'grid':
                        const gridSize = (params.upper - params.lower) / params.levels;
                        const position = Math.floor((currentPrice - params.lower) / gridSize);
                        
                        if (position <= 0) shouldBuy = true;
                        if (position >= params.levels) shouldSell = true;
                        break;
                }
                
                const amount = balance * 0.1 / currentPrice; // æ¯æ¬¡äº¤æ˜“10%èµ„é‡‘
                
                if (shouldBuy && balance > amount * currentPrice) {
                    balance -= amount * currentPrice;
                    coins += amount;
                    trades++;
                } else if (shouldSell && coins > amount) {
                    balance += amount * currentPrice;
                    coins -= amount;
                    trades++;
                }
            }
            
            const finalValue = balance + coins * priceHistory[priceHistory.length - 1];
            const profit = finalValue - 100000;
            const profitPercent = (profit / 100000 * 100).toFixed(2);
            
            const results = document.getElementById('backtest-results');
            results.innerHTML = `
                <h4>${strategyName} å›æµ‹ç»“æœ</h4>
                <p>åˆå§‹èµ„é‡‘: 100,000.00 å…ƒ</p>
                <p>æœ€ç»ˆä»·å€¼: ${finalValue.toFixed(2)} å…ƒ</p>
                <p>æ€»ç›ˆäº: ${profit >= 0 ? '+' : ''}${profit.toFixed(2)} å…ƒ (${profitPercent}%)</p>
                <p>äº¤æ˜“æ¬¡æ•°: ${trades}</p>
                <p>å¹´åŒ–æ”¶ç›Šç‡: ${(profitPercent * 12).toFixed(2)}%</p>
            `;
            results.style.display = 'block';
            
            showNotification(`ç­–ç•¥å›æµ‹å®Œæˆ: æœ€ç»ˆä»·å€¼ ${finalValue.toFixed(2)} å…ƒ`, "success");
        }
        
        // æœŸè´§ä¹°å…¥åšå¤š
        function buyFutures() {
            const amount = parseInt(document.getElementById('futures-amount').value);
            const leverage = parseInt(document.getElementById('futures-leverage').value);
            const price = parseFloat(document.getElementById('futures-price').value);
            
            const margin = (amount * price) / leverage;
            
            if (margin > userCash) {
                showNotification(`ä¿è¯é‡‘ä¸è¶³ï¼éœ€è¦ ${margin.toFixed(2)} å…ƒ`, "error");
                return;
            }
            
            futuresPositions.push({
                type: 'long',
                amount: amount,
                entryPrice: price,
                margin: margin,
                leverage: leverage,
                liquidationPrice: price * (1 - 1/leverage)
            });
            
            userCash -= margin;
            updateUserBalance();
            updateFuturesPositions();
            
            showNotification(`æœŸè´§åšå¤šä»“ä½å·²å»ºç«‹: ${amount} å¼  @ ${price} (${leverage}å€æ æ†)`, "success");
        }
        
        // æœŸè´§å–å‡ºåšç©º
        function sellFutures() {
            const amount = parseInt(document.getElementById('futures-amount').value);
            const leverage = parseInt(document.getElementById('futures-leverage').value);
            const price = parseFloat(document.getElementById('futures-price').value);
            
            const margin = (amount * price) / leverage;
            
            if (margin > userCash) {
                showNotification(`ä¿è¯é‡‘ä¸è¶³ï¼éœ€è¦ ${margin.toFixed(2)} å…ƒ`, "error");
                return;
            }
            
            futuresPositions.push({
                type: 'short',
                amount: amount,
                entryPrice: price,
                margin: margin,
                leverage: leverage,
                liquidationPrice: price * (1 + 1/leverage)
            });
            
            userCash -= margin;
            updateUserBalance();
            updateFuturesPositions();
            
            showNotification(`æœŸè´§åšç©ºä»“ä½å·²å»ºç«‹: ${amount} å¼  @ ${price} (${leverage}å€æ æ†)`, "success");
        }
        
        // æ›´æ–°æœŸè´§æŒä»“æ˜¾ç¤º
        function updateFuturesPositions() {
            const container = document.getElementById('futures-list');
            container.innerHTML = '';
            
            futuresPositions.forEach((position, index) => {
                const profit = position.type === 'long'
                    ? (currentPrice - position.entryPrice) * position.amount
                    : (position.entryPrice - currentPrice) * position.amount;
                
                const profitPercent = (profit / position.margin * 100).toFixed(2);
                
                const positionElement = document.createElement('div');
                positionElement.className = 'portfolio-item';
                positionElement.innerHTML = `
                    <span>${position.type === 'long' ? 'åšå¤š' : 'åšç©º'} ${position.amount} å¼  @ ${position.entryPrice.toFixed(4)} (${position.leverage}Ã—)</span>
                    <span class="portfolio-profit ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                        ${profit >= 0 ? '+' : ''}${profit.toFixed(2)} (${profitPercent}%)
                    </span>
                    <button class="btn btn-warning" onclick="closeFuturesPosition(${index})">å¹³ä»“</button>
                `;
                
                container.appendChild(positionElement);
                
                // æ£€æŸ¥å¼ºå¹³
                if ((position.type === 'long' && currentPrice <= position.liquidationPrice) ||
                    (position.type === 'short' && currentPrice >= position.liquidationPrice)) {
                    showNotification(`æœŸè´§ä»“ä½è§¦å‘å¼ºå¹³ï¼æŸå¤±ä¿è¯é‡‘ ${position.margin.toFixed(2)} å…ƒ`, "error");
                    futuresPositions.splice(index, 1);
                    updateFuturesPositions();
                }
            });
            
            if (futuresPositions.length === 0) {
                container.innerHTML = '<p>æ²¡æœ‰æœŸè´§æŒä»“</p>';
            }
        }
        
        // å¹³ä»“æœŸè´§
        function closeFuturesPosition(index) {
            if (index < 0 || index >= futuresPositions.length) return;
            
            const position = futuresPositions[index];
            let profit;
            
            if (position.type === 'long') {
                profit = (currentPrice - position.entryPrice) * position.amount;
            } else {
                profit = (position.entryPrice - currentPrice) * position.amount;
            }
            
            userCash += position.margin + profit;
            futuresPositions.splice(index, 1);
            
            updateUserBalance();
            updateFuturesPositions();
            
            showNotification(`æœŸè´§ä»“ä½å·²å¹³ä»“ï¼Œ${profit >= 0 ? 'ç›ˆåˆ©' : 'äºæŸ'} ${Math.abs(profit).toFixed(2)} å…ƒ`, 
                            profit >= 0 ? "success" : "error");
        }
        
        // ä¹°å…¥æœŸæƒ
        function buyOptions() {
            const type = document.getElementById('options-type').value;
            const strike = parseFloat(document.getElementById('options-strike').value);
            const amount = parseInt(document.getElementById('options-amount').value);
            const premium = parseFloat(document.getElementById('options-premium').value);
            
            const cost = amount * premium;
            
            if (cost > userCash) {
                showNotification(`èµ„é‡‘ä¸è¶³ï¼éœ€è¦ ${cost.toFixed(2)} å…ƒ`, "error");
                return;
            }
            
            optionsPositions.push({
                type: type,
                strike: strike,
                amount: amount,
                premium: premium,
                purchasePrice: currentPrice,
                expiry: document.getElementById('options-expiry').value
            });
            
            userCash -= cost;
            updateUserBalance();
            updateOptionsPositions();
            
            showNotification(`å·²ä¹°å…¥ ${amount} å¼ ${type === 'call' ? 'çœ‹æ¶¨' : 'çœ‹è·Œ'}æœŸæƒ (è¡Œæƒä»· ${strike})`, "success");
        }
        
        // å–å‡ºæœŸæƒ
        function sellOptions() {
            const type = document.getElementById('options-type').value;
            const strike = parseFloat(document.getElementById('options-strike').value);
            const amount = parseInt(document.getElementById('options-amount').value);
            const premium = parseFloat(document.getElementById('options-premium').value);
            
            optionsPositions.push({
                type: type,
                strike: strike,
                amount: -amount, // è´Ÿæ•°è¡¨ç¤ºå–å‡º
                premium: premium,
                salePrice: currentPrice,
                expiry: document.getElementById('options-expiry').value
            });
            
            userCash += amount * premium;
            updateUserBalance();
            updateOptionsPositions();
            
            showNotification(`å·²å–å‡º ${amount} å¼ ${type === 'call' ? 'çœ‹æ¶¨' : 'çœ‹è·Œ'}æœŸæƒ (è¡Œæƒä»· ${strike})`, "success");
        }
        
        // æ›´æ–°æœŸæƒæŒä»“æ˜¾ç¤º
        function updateOptionsPositions() {
            const container = document.getElementById('options-list');
            container.innerHTML = '';
            
            optionsPositions.forEach((option, index) => {
                let value = 0;
                let profit = 0;
                
                if (option.amount > 0) {
                    // ä¹°å…¥æœŸæƒ
                    if (option.type === 'call') {
                        value = Math.max(0, currentPrice - option.strike);
                    } else {
                        value = Math.max(0, option.strike - currentPrice);
                    }
                    
                    profit = (value - option.premium) * option.amount;
                } else {
                    // å–å‡ºæœŸæƒ
                    if (option.type === 'call') {
                        value = Math.max(0, currentPrice - option.strike);
                    } else {
                        value = Math.max(0, option.strike - currentPrice);
                    }
                    
                    profit = (option.premium - value) * -option.amount;
                }
                
                const positionElement = document.createElement('div');
                positionElement.className = 'portfolio-item';
                positionElement.innerHTML = `
                    <span>${option.type === 'call' ? 'çœ‹æ¶¨' : 'çœ‹è·Œ'} ${Math.abs(option.amount)} å¼  @ ${option.strike.toFixed(4)} (${option.amount > 0 ? 'ä¹°å…¥' : 'å–å‡º'})</span>
                    <span class="portfolio-profit ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                        ${profit >= 0 ? '+' : ''}${profit.toFixed(2)}
                    </span>
                    <button class="btn btn-warning" onclick="closeOptionsPosition(${index})">å¹³ä»“</button>
                `;
                
                container.appendChild(positionElement);
            });
            
            if (optionsPositions.length === 0) {
                container.innerHTML = '<p>æ²¡æœ‰æœŸæƒæŒä»“</p>';
            }
        }
        
        // å¹³ä»“æœŸæƒ
        function closeOptionsPosition(index) {
            if (index < 0 || index >= optionsPositions.length) return;
            
            const option = optionsPositions[index];
            let profit;
            
            if (option.amount > 0) {
                // ä¹°å…¥æœŸæƒå¹³ä»“
                let value = 0;
                if (option.type === 'call') {
                    value = Math.max(0, currentPrice - option.strike);
                } else {
                    value = Math.max(0, option.strike - currentPrice);
                }
                
                profit = (value - option.premium) * option.amount;
                userCash += value * option.amount;
            } else {
                // å–å‡ºæœŸæƒå¹³ä»“
                let value = 0;
                if (option.type === 'call') {
                    value = Math.max(0, currentPrice - option.strike);
                } else {
                    value = Math.max(0, option.strike - currentPrice);
                }
                
                profit = (option.premium - value) * -option.amount;
                userCash -= value * -option.amount;
            }
            
            optionsPositions.splice(index, 1);
            updateUserBalance();
            updateOptionsPositions();
            
            showNotification(`æœŸæƒä»“ä½å·²å¹³ä»“ï¼Œ${profit >= 0 ? 'ç›ˆåˆ©' : 'äºæŸ'} ${Math.abs(profit).toFixed(2)} å…ƒ`, 
                            profit >= 0 ? "success" : "error");
        }
        
        // æ°¸ç»­åˆçº¦åšå¤š
        function longSwap() {
            const amount = parseInt(document.getElementById('swap-amount').value);
            const leverage = parseInt(document.getElementById('swap-leverage').value);
            
            const margin = (amount * currentPrice) / leverage;
            
            if (margin > userCash) {
                showNotification(`ä¿è¯é‡‘ä¸è¶³ï¼éœ€è¦ ${margin.toFixed(2)} å…ƒ`, "error");
                return;
            }
            
            swapPositions.push({
                type: 'long',
                amount: amount,
                entryPrice: currentPrice,
                margin: margin,
                leverage: leverage,
                liquidationPrice: currentPrice * (1 - 1/leverage)
            });
            
            userCash -= margin;
            updateUserBalance();
            updateSwapPositions();
            
            showNotification(`æ°¸ç»­åˆçº¦åšå¤šä»“ä½å·²å»ºç«‹: ${amount} å¼  @ ${currentPrice.toFixed(4)} (${leverage}å€æ æ†)`, "success");
        }
        
        // æ°¸ç»­åˆçº¦åšç©º
        function shortSwap() {
            const amount = parseInt(document.getElementById('swap-amount').value);
            const leverage = parseInt(document.getElementById('swap-leverage').value);
            
            const margin = (amount * currentPrice) / leverage;
            
            if (margin > userCash) {
                showNotification(`ä¿è¯é‡‘ä¸è¶³ï¼éœ€è¦ ${margin.toFixed(2)} å…ƒ`, "error");
                return;
            }
            
            swapPositions.push({
                type: 'short',
                amount: amount,
                entryPrice: currentPrice,
                margin: margin,
                leverage: leverage,
                liquidationPrice: currentPrice * (1 + 1/leverage)
            });
            
            userCash -= margin;
            updateUserBalance();
            updateSwapPositions();
            
            showNotification(`æ°¸ç»­åˆçº¦åšç©ºä»“ä½å·²å»ºç«‹: ${amount} å¼  @ ${currentPrice.toFixed(4)} (${leverage}å€æ æ†)`, "success");
        }
        
        // æ›´æ–°æ°¸ç»­åˆçº¦æŒä»“æ˜¾ç¤º
        function updateSwapPositions() {
            const container = document.getElementById('swap-list');
            container.innerHTML = '';
            
            swapPositions.forEach((swap, index) => {
                const profit = swap.type === 'long'
                    ? (currentPrice - swap.entryPrice) * swap.amount * swap.leverage
                    : (swap.entryPrice - currentPrice) * swap.amount * swap.leverage;
                
                const profitPercent = (profit / swap.margin * 100).toFixed(2);
                
                const positionElement = document.createElement('div');
                positionElement.className = 'portfolio-item';
                positionElement.innerHTML = `
                    <span>${swap.type === 'long' ? 'åšå¤š' : 'åšç©º'} ${swap.amount} å¼  @ ${swap.entryPrice.toFixed(4)} (${swap.leverage}Ã—)</span>
                    <span class="portfolio-profit ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                        ${profit >= 0 ? '+' : ''}${profit.toFixed(2)} (${profitPercent}%)
                    </span>
                    <button class="btn btn-warning" onclick="closeSwapPosition(${index})">å¹³ä»“</button>
                `;
                
                container.appendChild(positionElement);
                
                // æ£€æŸ¥å¼ºå¹³
                if ((swap.type === 'long' && currentPrice <= swap.liquidationPrice) ||
                    (swap.type === 'short' && currentPrice >= swap.liquidationPrice)) {
                    showNotification(`æ°¸ç»­åˆçº¦ä»“ä½è§¦å‘å¼ºå¹³ï¼æŸå¤±ä¿è¯é‡‘ ${swap.margin.toFixed(2)} å…ƒ`, "error");
                    swapPositions.splice(index, 1);
                    updateSwapPositions();
                }
            });
            
            if (swapPositions.length === 0) {
                container.innerHTML = '<p>æ²¡æœ‰æ°¸ç»­åˆçº¦æŒä»“</p>';
            }
        }
        
        // å¹³ä»“æ°¸ç»­åˆçº¦
        function closeSwapPosition(index) {
            if (index < 0 || index >= swapPositions.length) return;
            
            const swap = swapPositions[index];
            let profit;
            
            if (swap.type === 'long') {
                profit = (currentPrice - swap.entryPrice) * swap.amount * swap.leverage;
            } else {
                profit = (swap.entryPrice - currentPrice) * swap.amount * swap.leverage;
            }
            
            userCash += swap.margin + profit;
            swapPositions.splice(index, 1);
            
            updateUserBalance();
            updateSwapPositions();
            
            showNotification(`æ°¸ç»­åˆçº¦ä»“ä½å·²å¹³ä»“ï¼Œ${profit >= 0 ? 'ç›ˆåˆ©' : 'äºæŸ'} ${Math.abs(profit).toFixed(2)} å…ƒ`, 
                            profit >= 0 ? "success" : "error");
        }
        
        // å¯¹å†²æŠ•èµ„ç»„åˆ
        function hedgePortfolio() {
            if (userCoins <= 0) {
                showNotification("æ²¡æœ‰æ³¢åŠ¨å¸æŒä»“éœ€è¦å¯¹å†²", "info");
                return;
            }
            
            // ç®€å•å¯¹å†²ï¼šå–å‡ºæœŸè´§æˆ–ä¹°å…¥çœ‹è·ŒæœŸæƒ
            const hedgeAmount = Math.min(userCoins, totalSupply * 0.01); // å¯¹å†²ä¸è¶…è¿‡æŒä»“é‡
            
            // éšæœºé€‰æ‹©å¯¹å†²æ–¹å¼
            if (Math.random() > 0.5) {
                // æœŸè´§å¯¹å†²
                futuresPositions.push({
                    type: 'short',
                    amount: hedgeAmount,
                    entryPrice: currentPrice,
                    margin: (hedgeAmount * currentPrice) / 5, // 5å€æ æ†
                    leverage: 5,
                    liquidationPrice: currentPrice * 1.2
                });
                
                userCash -= (hedgeAmount * currentPrice) / 5;
                showNotification(`å·²å»ºç«‹æœŸè´§å¯¹å†²ä»“ä½: åšç©º ${hedgeAmount} å¼  @ ${currentPrice.toFixed(4)} (5å€æ æ†)`, "success");
            } else {
                // æœŸæƒå¯¹å†²
                const premium = currentPrice * 0.05; // æœŸæƒè´¹5%
                const cost = hedgeAmount * premium;
                
                if (cost > userCash) {
                    showNotification(`èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•ä¹°å…¥çœ‹è·ŒæœŸæƒå¯¹å†²ï¼éœ€è¦ ${cost.toFixed(2)} å…ƒ`, "error");
                    return;
                }
                
                optionsPositions.push({
                    type: 'put',
                    strike: currentPrice * 0.95, // è¡Œæƒä»·ä½äºå½“å‰ä»·5%
                    amount: hedgeAmount,
                    premium: premium,
                    purchasePrice: currentPrice,
                    expiry: 'monthly'
                });
                
                userCash -= cost;
                showNotification(`å·²ä¹°å…¥çœ‹è·ŒæœŸæƒå¯¹å†²: ${hedgeAmount} å¼  @ ${(currentPrice * 0.95).toFixed(4)}`, "success");
            }
            
            updateUserBalance();
            updateFuturesPositions();
            updateOptionsPositions();
        }
        
        // æ¨¡æ‹Ÿåˆ°æœŸç»“ç®—
        function simulateExpiry() {
            // æœŸè´§ç»“ç®—
            futuresPositions.forEach((future, index) => {
                const profit = future.type === 'long'
                    ? (currentPrice - future.entryPrice) * future.amount
                    : (future.entryPrice - currentPrice) * future.amount;
                
                userCash += future.margin + profit;
                showNotification(`æœŸè´§åˆçº¦åˆ°æœŸç»“ç®—: ${profit >= 0 ? 'ç›ˆåˆ©' : 'äºæŸ'} ${Math.abs(profit).toFixed(2)} å…ƒ`, 
                                profit >= 0 ? "success" : "error");
            });
            
            futuresPositions = [];
            
            // æœŸæƒç»“ç®—
            optionsPositions.forEach((option, index) => {
                let value = 0;
                
                if (option.type === 'call') {
                    value = Math.max(0, currentPrice - option.strike);
                } else {
                    value = Math.max(0, option.strike - currentPrice);
                }
                
                if (option.amount > 0) {
                    // ä¹°å…¥æœŸæƒ
                    const profit = (value - option.premium) * option.amount;
                    userCash += value * option.amount;
                    showNotification(`çœ‹${option.type === 'call' ? 'æ¶¨' : 'è·Œ'}æœŸæƒåˆ°æœŸç»“ç®—: ${profit >= 0 ? 'ç›ˆåˆ©' : 'äºæŸ'} ${Math.abs(profit).toFixed(2)} å…ƒ`, 
                                    profit >= 0 ? "success" : "error");
                } else {
                    // å–å‡ºæœŸæƒ
                    const profit = (option.premium - value) * -option.amount;
                    userCash -= value * -option.amount;
                    showNotification(`å–å‡ºçœ‹${option.type === 'call' ? 'æ¶¨' : 'è·Œ'}æœŸæƒåˆ°æœŸç»“ç®—: ${profit >= 0 ? 'ç›ˆåˆ©' : 'äºæŸ'} ${Math.abs(profit).toFixed(2)} å…ƒ`, 
                                    profit >= 0 ? "success" : "error");
                }
            });
            
            optionsPositions = [];
            
            updateUserBalance();
            updateFuturesPositions();
            updateOptionsPositions();
            showNotification("æ‰€æœ‰è¡ç”Ÿå“åˆçº¦å·²åˆ°æœŸç»“ç®—", "info");
        }
        
        // å¹³ä»“æ‰€æœ‰è¡ç”Ÿå“
        function liquidateDerivatives() {
            // å¹³ä»“æœŸè´§
            futuresPositions.forEach((future, index) => {
                const profit = future.type === 'long'
                    ? (currentPrice - future.entryPrice) * future.amount
                    : (future.entryPrice - currentPrice) * future.amount;
                
                userCash += future.margin + profit;
            });
            
            futuresPositions = [];
            
            // å¹³ä»“æœŸæƒ
            optionsPositions.forEach((option, index) => {
                let value = 0;
                
                if (option.type === 'call') {
                    value = Math.max(0, currentPrice - option.strike);
                } else {
                    value = Math.max(0, option.strike - currentPrice);
                }
                
                if (option.amount > 0) {
                    // ä¹°å…¥æœŸæƒ
                    userCash += value * option.amount;
                } else {
                    // å–å‡ºæœŸæƒ
                    userCash -= value * -option.amount;
                }
            });
            
            optionsPositions = [];
            
            // å¹³ä»“æ°¸ç»­åˆçº¦
            swapPositions.forEach((swap, index) => {
                const profit = swap.type === 'long'
                    ? (currentPrice - swap.entryPrice) * swap.amount * swap.leverage
                    : (swap.entryPrice - currentPrice) * swap.amount * swap.leverage;
                
                userCash += swap.margin + profit;
            });
            
            swapPositions = [];
            
            updateUserBalance();
            updateFuturesPositions();
            updateOptionsPositions();
            updateSwapPositions();
            showNotification("æ‰€æœ‰è¡ç”Ÿå“ä»“ä½å·²å¹³ä»“", "info");
        }
        
        // åˆ‡æ¢æš—é»‘æ¨¡å¼
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            // æ›´æ–°å›¾è¡¨ä¸»é¢˜
            updateChartTheme();
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.getElementById('darkModeToggle').textContent = isDarkMode ? 'â˜€ï¸ æ˜äº®æ¨¡å¼' : 'ğŸŒ“ æš—é»‘æ¨¡å¼';
        }
        
        // æ›´æ–°å›¾è¡¨ä¸»é¢˜
        function updateChartTheme() {
            if (!chart) return;
            
            // æ›´æ–°ä»·æ ¼å›¾è¡¨
            chart.options.scales.y.grid.color = isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
            chart.options.scales.y.ticks.color = isDarkMode ? '#ffffff' : '#333333';
            chart.options.scales.x.ticks.color = isDarkMode ? '#ffffff' : '#333333';
            chart.options.plugins.legend.labels.color = isDarkMode ? '#ffffff' : '#333333';
            chart.update();
            
            // æ›´æ–°æ·±åº¦å›¾è¡¨
            if (depthChart) {
                depthChart.options.scales.y.grid.color = isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
                depthChart.options.scales.y.ticks.color = isDarkMode ? '#ffffff' : '#333333';
                depthChart.options.scales.x.ticks.color = isDarkMode ? '#ffffff' : '#333333';
                depthChart.options.plugins.legend.labels.color = isDarkMode ? '#ffffff' : '#333333';
                depthChart.update();
            }
            
            // æ›´æ–°èµ„äº§åˆ†é…å›¾è¡¨
            if (allocationChart) {
                allocationChart.options.plugins.legend.labels.color = isDarkMode ? '#ffffff' : '#333333';
                allocationChart.update();
            }
            
            // æ›´æ–°è¡¨ç°å›¾è¡¨
            if (performanceChart) {
                performanceChart.options.scales.y.grid.color = isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
                performanceChart.options.scales.y.ticks.color = isDarkMode ? '#ffffff' : '#333333';
                performanceChart.options.scales.x.ticks.color = isDarkMode ? '#ffffff' : '#333333';
                performanceChart.options.plugins.legend.labels.color = isDarkMode ? '#ffffff' : '#333333';
                performanceChart.update();
            }
            
            // æ›´æ–°é£é™©å›¾è¡¨
            if (riskChart) {
                riskChart.options.scales.r.angleLines.color = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                riskChart.options.scales.r.grid.color = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                riskChart.options.scales.r.pointLabels.color = isDarkMode ? '#ffffff' : '#333333';
                riskChart.options.scales.r.ticks.backdropColor = isDarkMode ? '#121212' : '#ffffff';
                riskChart.options.scales.r.ticks.color = isDarkMode ? '#ffffff' : '#333333';
                riskChart.options.plugins.legend.labels.color = isDarkMode ? '#ffffff' : '#333333';
                riskChart.update();
            }
        }
        
        // é‡ç½®ç”¨æˆ·èµ„äº§
        function resetBalance() {
            userCash = 100000;
            userCoins = 0;
            leveragedPositions = [];
            futuresPositions = [];
            optionsPositions = [];
            swapPositions = [];
            transactions = [];
            portfolioHistory = [];
            
            updateUserBalance();
            updateTransactionHistory();
            updateFuturesPositions();
            updateOptionsPositions();
            updateSwapPositions();
            
            showNotification("èµ„äº§å·²é‡ç½®ä¸ºåˆå§‹çŠ¶æ€", "success");
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            updateMarketData(currentPrice);
            updateUserBalance();
            updateTradeForms();
            updateFuturesPositions();
            updateOptionsPositions();
            updateSwapPositions();
            
            // æ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
                });
            });
            
            // æ æ†æ»‘å—
            document.getElementById('leverage-amount').addEventListener('input', function() {
                userLeverage = parseInt(this.value);
                document.getElementById('leverage-display').textContent = userLeverage + 'Ã—';
                updateUserBalance();
            });
            
            // ä»“ä½å¤§å°æ»‘å—
            document.getElementById('position-size').addEventListener('input', function() {
                document.getElementById('position-size-value').textContent = this.value + '%';
            });
            
            // ç­–ç•¥èµ„é‡‘æ»‘å—
            document.getElementById('strategy-capital').addEventListener('input', function() {
                document.getElementById('strategy-capital-value').textContent = this.value + '%';
            });
            
            // åšå¸‚å•†ä»·å·®æ»‘å—
            document.getElementById('maker-spread').addEventListener('input', function() {
                document.getElementById('maker-spread-value').textContent = this.value + '%';
            });
            
            // æ•°é‡è¾“å…¥äº‹ä»¶
            document.getElementById('buy-amount').addEventListener('input', updateTradeForms);
            document.getElementById('sell-amount').addEventListener('input', updateTradeForms);
            
            // è®¢å•ç±»å‹å˜åŒ–
            document.getElementById('buy-order-type').addEventListener('change', function() {
                document.getElementById('buy-limit-group').style.display = 
                    this.value === 'limit' ? 'block' : 'none';
            });
            
            document.getElementById('sell-order-type').addEventListener('change', function() {
                document.getElementById('sell-limit-group').style.display = 
                    this.value === 'limit' ? 'block' : 'none';
            });
            
            document.getElementById('place-order-type').addEventListener('change', function() {
                document.getElementById('price-group').style.display = 
                    (this.value === 'limit' || this.value === 'stop-limit') ? 'block' : 'none';
                document.getElementById('stop-price-group').style.display = 
                    (this.value === 'stop' || this.value === 'stop-limit') ? 'block' : 'none';
            });
            
            document.getElementById('strategy-select').addEventListener('change', function() {
                document.querySelectorAll('.strategy-params').forEach(el => {
                    el.style.display = 'none';
                });
                
                if (this.value === 'mean-reversion') {
                    document.getElementById('mean-reversion-params').style.display = 'block';
                } else if (this.value === 'momentum') {
                    document.getElementById('momentum-params').style.display = 'block';
                } else if (this.value === 'grid') {
                    document.getElementById('grid-params').style.display = 'block';
                }
            });
            
            // åŸºæœ¬æ³¢åŠ¨æŒ‰é’®
            document.getElementById('small-up').addEventListener('click', () => changePrice(0.02, 'manual'));
            document.getElementById('small-down').addEventListener('click', () => changePrice(-0.02, 'manual'));
            document.getElementById('random-normal').addEventListener('click', () => {
                currentMode = 'random';
                randomFluctuation();
            });
            document.getElementById('medium-up').addEventListener('click', () => changePrice(0.08, 'manual'));
            document.getElementById('medium-down').addEventListener('click', () => changePrice(-0.08, 'manual'));
            
            // æç«¯è¡Œæƒ…æŒ‰é’®
            document.getElementById('large-up').addEventListener('click', () => changePrice(0.20, 'manual'));
            document.getElementById('large-down').addEventListener('click', () => changePrice(-0.20, 'manual'));
            document.getElementById('flash-crash').addEventListener('click', () => {
                changePrice(-0.50, 'manual');
                dailyVolume += totalSupply * currentPrice * 0.5; // å¤§é‡äº¤æ˜“é‡
            });
            document.getElementById('moon-shot').addEventListener('click', () => {
                changePrice(1.00, 'manual');
                dailyVolume += totalSupply * currentPrice * 0.3;
            });
            document.getElementById('bubble-burst').addEventListener('click', () => {
                changePrice(-0.70, 'manual');
                dailyVolume += totalSupply * currentPrice * 0.8;
            });
            document.getElementById('dead-cat-bounce').addEventListener('click', deadCatBounce);
            
            // å¸‚åœºå½¢æ€æŒ‰é’®
            document.getElementById('sideways').addEventListener('click', () => {
                currentMode = 'sideways';
                if (!autoIntervalId) randomFluctuation();
                showNotification("å·²åˆ‡æ¢ä¸ºæ¨ªç›˜éœ‡è¡æ¨¡å¼", "info");
            });
            document.getElementById('volatile').addEventListener('click', () => {
                currentMode = 'volatile';
                if (!autoIntervalId) randomFluctuation();
                showNotification("å·²åˆ‡æ¢ä¸ºå‰§çƒˆæ³¢åŠ¨æ¨¡å¼", "info");
            });
            document.getElementById('trend-up').addEventListener('click', () => {
                trendDirection = 1;
                trendCount = 5;
                currentMode = 'trend';
                if (!autoIntervalId) randomFluctuation();
                showNotification("å·²åˆ‡æ¢ä¸ºä¸Šå‡è¶‹åŠ¿æ¨¡å¼", "info");
            });
            document.getElementById('trend-down').addEventListener('click', () => {
                trendDirection = -1;
                trendCount = 5;
                currentMode = 'trend';
                if (!autoIntervalId) randomFluctuation();
                showNotification("å·²åˆ‡æ¢ä¸ºä¸‹é™è¶‹åŠ¿æ¨¡å¼", "info");
            });
            document.getElementById('support-test').addEventListener('click', () => {
                changePrice((supportLevel - currentPrice) / currentPrice, 'manual');
                showNotification(`æµ‹è¯•æ”¯æ’‘ä½ ${supportLevel.toFixed(2)}`, "info");
            });
            document.getElementById('resistance-test').addEventListener('click', () => {
                changePrice((resistanceLevel - currentPrice) / currentPrice, 'manual');
                showNotification(`æµ‹è¯•é˜»åŠ›ä½ ${resistanceLevel.toFixed(2)}`, "info");
            });
            document.getElementById('rollercoaster-btn').addEventListener('click', startRollercoaster);
            document.getElementById('head-shoulders').addEventListener('click', headAndShoulders);
            document.getElementById('double-bottom').addEventListener('click', doubleBottom);
            
            // ç³»ç»Ÿæ“ä½œæŒ‰é’®
            document.getElementById('reset-price').addEventListener('click', () => {
                const oldPrice = currentPrice;
                currentPrice = 5.00;
                updatePriceDisplay(currentPrice, oldPrice);
                showNotification("ä»·æ ¼å·²é‡ç½®ä¸º5.00å…ƒ", "info");
            });
            document.getElementById('reset-history').addEventListener('click', () => {
                priceHistory = generateInitialHistory(30, 4.5, 6.0);
                priceHistory[29] = currentPrice; // ä¿æŒå½“å‰ä»·æ ¼
                updateChart();
                showNotification("å†å²æ•°æ®å·²é‡ç½®", "info");
            });
            document.getElementById('add-liquidity').addEventListener('click', () => {
                totalSupply *= 1.5;
                marketCap = totalSupply * currentPrice;
                showNotification("å·²å¢åŠ å¸‚åœºæµåŠ¨æ€§ï¼Œæ€»ä¾›åº”é‡å¢åŠ 50%", "info");
            });
            document.getElementById('panic-sell').addEventListener('click', () => {
                changePrice(-0.30, 'manual');
                dailyVolume += totalSupply * currentPrice * 0.7;
                showNotification("å¸‚åœºææ…Œæ€§æŠ›å”®ï¼", "warning");
            });
            document.getElementById('market-maker-btn').addEventListener('click', () => {
                currentMode = 'market-maker';
                if (!autoIntervalId) {
                    const interval = parseInt(document.getElementById('autoInterval').value) * 1000;
                    autoIntervalId = setInterval(randomFluctuation, interval);
                    document.getElementById('toggleAuto').textContent = 'åœæ­¢è‡ªåŠ¨æ³¢åŠ¨';
                    document.getElementById('toggleAuto').className = 'btn btn-warning';
                }
                showNotification("åšå¸‚å•†æ¨¡å¼æ¿€æ´»ï¼Œå°†ç»´æŒå¸‚åœºæµåŠ¨æ€§", "info");
            });
            document.getElementById('reset-balance').addEventListener('click', resetBalance);
            
            // æŠ€æœ¯åˆ†ææŒ‰é’®
            document.getElementById('show-ma').addEventListener('click', () => {
                const ma5 = (priceHistory.slice(-5).reduce((a,b) => a+b, 0)/5).toFixed(2);
                const ma10 = (priceHistory.slice(-10).reduce((a,b) => a+b, 0)/10).toFixed(2);
                const ma30 = (priceHistory.slice(-30).reduce((a,b) => a+b, 0)/30).toFixed(2);
                
                document.getElementById('indicator-display').innerHTML = `
                    <div style="text-align: center;">
                        <h4>ç§»åŠ¨å¹³å‡çº¿ (MA)</h4>
                        <p>5æ—¥å‡çº¿: ${ma5}</p>
                        <p>10æ—¥å‡çº¿: ${ma10}</p>
                        <p>30æ—¥å‡çº¿: ${ma30}</p>
                    </div>
                `;
            });
            
            document.getElementById('show-macd').addEventListener('click', () => {
                const dif = (Math.random()*2-1).toFixed(4);
                const dea = (Math.random()*2-1).toFixed(4);
                const macd = (Math.random()*0.5-0.25).toFixed(4);
                
                document.getElementById('indicator-display').innerHTML = `
                    <div style="text-align: center;">
                        <h4>MACD æŒ‡æ ‡</h4>
                        <p>DIF: ${dif}</p>
                        <p>DEA: ${dea}</p>
                        <p>MACD: ${macd}</p>
                    </div>
                `;
            });
            
            document.getElementById('show-rsi').addEventListener('click', () => {
                const rsi6 = (30 + Math.random()*50).toFixed(2);
                const rsi12 = (30 + Math.random()*50).toFixed(2);
                const rsi24 = (30 + Math.random()*50).toFixed(2);
                
                document.getElementById('indicator-display').innerHTML = `
                    <div style="text-align: center;">
                        <h4>RSI æŒ‡æ ‡</h4>
                        <p>6æ—¥RSI: ${rsi6}</p>
                        <p>12æ—¥RSI: ${rsi12}</p>
                        <p>24æ—¥RSI: ${rsi24}</p>
                    </div>
                `;
            });
            
            document.getElementById('show-bollinger').addEventListener('click', () => {
                const mid = priceHistory.slice(-20).reduce((a,b) => a+b, 0)/20;
                const std = Math.sqrt(priceHistory.slice(-20).reduce((a,b) => a+Math.pow(b-mid,2),0)/20);
                const upper = mid + 2*std;
                const lower = mid - 2*std;
                
                document.getElementById('indicator-display').innerHTML = `
                    <div style="text-align: center;">
                        <h4>å¸ƒæ—å¸¦æŒ‡æ ‡</h4>
                        <p>ä¸Šè½¨: ${upper.toFixed(2)}</p>
                        <p>ä¸­è½¨: ${mid.toFixed(2)}</p>
                        <p>ä¸‹è½¨: ${lower.toFixed(2)}</p>
                    </div>
                `;
            });
            
            document.getElementById('show-fibonacci').addEventListener('click', () => {
                const high = Math.max(...priceHistory.slice(-30));
                const low = Math.min(...priceHistory.slice(-30));
                const diff = high - low;
                const fib236 = high - diff*0.236;
                const fib382 = high - diff*0.382;
                const fib50 = high - diff*0.5;
                const fib618 = high - diff*0.618;
                
                document.getElementById('indicator-display').innerHTML = `
                    <div style="text-align: center;">
                        <h4>æ–æ³¢é‚£å¥‘å›æ’¤ä½</h4>
                        <p>0%: ${high.toFixed(2)} (é«˜ç‚¹)</p>
                        <p>23.6%: ${fib236.toFixed(2)}</p>
                        <p>38.2%: ${fib382.toFixed(2)}</p>
                        <p>50%: ${fib50.toFixed(2)}</p>
                        <p>61.8%: ${fib618.toFixed(2)}</p>
                        <p>100%: ${low.toFixed(2)} (ä½ç‚¹)</p>
                    </div>
                `;
            });
            
            document.getElementById('show-ichimoku').addEventListener('click', () => {
                const tenkan = (Math.max(...priceHistory.slice(-9)) + Math.min(...priceHistory.slice(-9))) / 2;
                const kijun = (Math.max(...priceHistory.slice(-26)) + Math.min(...priceHistory.slice(-26))) / 2;
                const senkouA = (tenkan + kijun) / 2;
                const senkouB = (Math.max(...priceHistory.slice(-52)) + Math.min(...priceHistory.slice(-52))) / 2;
                
                document.getElementById('indicator-display').innerHTML = `
                    <div style="text-align: center;">
                        <h4>ä¸€ç›®å‡è¡¡è¡¨</h4>
                        <p>è½¬æ¢çº¿: ${tenkan.toFixed(2)}</p>
                        <p>åŸºå‡†çº¿: ${kijun.toFixed(2)}</p>
                        <p>å…ˆè¡Œå¸¦A: ${senkouA.toFixed(2)}</p>
                        <p>å…ˆè¡Œå¸¦B: ${senkouB.toFixed(2)}</p>
                    </div>
                `;
            });
            
            document.getElementById('show-volume').addEventListener('click', () => {
                document.getElementById('indicator-display').innerHTML = `
                    <div style="text-align: center;">
                        <h4>æˆäº¤é‡åˆ†æ</h4>
                        <p>24å°æ—¶æˆäº¤é‡: ${dailyVolume.toLocaleString('zh-CN')} å…ƒ</p>
                        <p>é‡ä»·å…³ç³»: ${getVolumePriceRelation()}</p>
                    </div>
                `;
            });
            
            document.getElementById('apply-indicator').addEventListener('click', () => {
                const params = document.getElementById('indicator-params').value;
                showNotification(`æŒ‡æ ‡å‚æ•°å·²åº”ç”¨: ${params}`, "info");
            });
            
            document.getElementById('custom-indicator').addEventListener('click', () => {
                showNotification("è‡ªå®šä¹‰æŒ‡æ ‡åŠŸèƒ½å°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­æä¾›", "info");
            });
            
            document.getElementById('backtest-indicator').addEventListener('click', () => {
                showNotification("æŒ‡æ ‡å›æµ‹åŠŸèƒ½å°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­æä¾›", "info");
            });
            
            // é«˜çº§æ¨¡æ‹ŸæŒ‰é’®
            document.getElementById('pump-action').addEventListener('click', pumpAction);
            document.getElementById('dump-action').addEventListener('click', dumpAction);
            document.getElementById('whale-buy').addEventListener('click', whaleBuy);
            document.getElementById('whale-sell').addEventListener('click', whaleSell);
            document.getElementById('good-news').addEventListener('click', goodNews);
            document.getElementById('bad-news').addEventListener('click', badNews);
            document.getElementById('exchange-hack').addEventListener('click', exchangeHack);
            document.getElementById('regulatory').addEventListener('click', regulatoryNews);
            document.getElementById('bull-market').addEventListener('click', startBullMarket);
            document.getElementById('bear-market').addEventListener('click', startBearMarket);
            document.getElementById('accumulation').addEventListener('click', accumulationPhase);
            document.getElementById('distribution').addEventListener('click', distributionPhase);
            document.getElementById('apply-custom').addEventListener('click', applyCustomChange);
            document.getElementById('spoofing').addEventListener('click', spoofingOrder);
            document.getElementById('wash-trade').addEventListener('click', washTrade);
            document.getElementById('fork-event').addEventListener('click', forkEvent);
            document.getElementById('halving-event').addEventListener('click', halvingEvent);
            document.getElementById('airdrop').addEventListener('click', airdropEvent);
            document.getElementById('seasonal-effect').addEventListener('click', seasonalEffect);
            
            // åšå¸‚å•†æ§åˆ¶
            document.getElementById('activate-maker').addEventListener('click', () => {
                currentMode = 'market-maker';
                if (!autoIntervalId) {
                    const interval = parseInt(document.getElementById('autoInterval').value) * 1000;
                    autoIntervalId = setInterval(randomFluctuation, interval);
                    document.getElementById('toggleAuto').textContent = 'åœæ­¢è‡ªåŠ¨æ³¢åŠ¨';
                    document.getElementById('toggleAuto').className = 'btn btn-warning';
                }
                showNotification("åšå¸‚å•†æ¨¡å¼æ¿€æ´»ï¼Œå°†ç»´æŒå¸‚åœºæµåŠ¨æ€§", "info");
            });
            
            document.getElementById('stop-maker').addEventListener('click', () => {
                if (currentMode === 'market-maker') {
                    currentMode = 'random';
                    showNotification("åšå¸‚å•†æ¨¡å¼å·²åœç”¨", "info");
                } else {
                    showNotification("åšå¸‚å•†æ¨¡å¼æœªæ¿€æ´»", "info");
                }
            });
            
            // æ æ†å’Œæ•‘å¸‚æŒ‰é’®
            document.getElementById('leverage-buy').addEventListener('click', function() {
                const amount = parseFloat(document.getElementById('buy-amount').value) || 0;
                if(executeLeveragedTrade(amount, 'buy')) {
                    showNotification(`æˆåŠŸä½¿ç”¨ ${userLeverage}å€æ æ†ä¹°å…¥ ${(amount*userLeverage).toFixed(2)} æ³¢åŠ¨å¸`, "success");
                }
            });
            
            document.getElementById('leverage-sell').addEventListener('click', function() {
                const amount = parseFloat(document.getElementById('sell-amount').value) || 0;
                if(executeLeveragedTrade(amount, 'sell')) {
                    showNotification(`æˆåŠŸä½¿ç”¨ ${userLeverage}å€æ æ†å–å‡º ${(amount*userLeverage).toFixed(2)} æ³¢åŠ¨å¸`, "success");
                }
            });
            
            document.getElementById('market-rescue').addEventListener('click', marketRescue);
            document.getElementById('institutional-buy').addEventListener('click', institutionalBuy);
            document.getElementById('circuit-breaker').addEventListener('click', triggerCircuitBreaker);
            document.getElementById('stop-out').addEventListener('click', simulateStopOut);
            document.getElementById('hedge-position').addEventListener('click', hedgePortfolio);
            document.getElementById('liquidity-injection').addEventListener('click', () => {
                totalSupply *= 1.2;
                marketCap = totalSupply * currentPrice;
                showNotification("æµåŠ¨æ€§æ³¨å…¥ï¼šæ€»ä¾›åº”é‡å¢åŠ 20%", "info");
            });
            
            // è®¢å•ç°¿åŠŸèƒ½
            document.getElementById('place-order-btn').addEventListener('click', placeOrder);
            document.getElementById('cancel-all-orders').addEventListener('click', cancelAllOrders);
            
            // æŠ•èµ„ç»„åˆåŠŸèƒ½
            document.getElementById('rebalance-portfolio').addEventListener('click', () => {
                const targetCoinPercent = 0.3; // ç›®æ ‡30%æ³¢åŠ¨å¸
                const currentCoinValue = userCoins * currentPrice;
                const totalAssets = userCash + currentCoinValue;
                const targetCoinValue = totalAssets * targetCoinPercent;
                
                if (currentCoinValue > targetCoinValue) {
                    // å–å‡ºå¤šä½™æ³¢åŠ¨å¸
                    const sellAmount = (currentCoinValue - targetCoinValue) / currentPrice;
                    if (executeTrade(sellAmount, 'sell')) {
                        showNotification(`æŠ•èµ„ç»„åˆå†å¹³è¡¡: å–å‡º ${sellAmount.toFixed(2)} æ³¢åŠ¨å¸ä»¥è¾¾åˆ°ç›®æ ‡é…ç½®`, "info");
                    }
                } else if (currentCoinValue < targetCoinValue) {
                    // ä¹°å…¥ä¸è¶³æ³¢åŠ¨å¸
                    const buyAmount = (targetCoinValue - currentCoinValue) / currentPrice;
                    if (executeTrade(buyAmount, 'buy')) {
                        showNotification(`æŠ•èµ„ç»„åˆå†å¹³è¡¡: ä¹°å…¥ ${buyAmount.toFixed(2)} æ³¢åŠ¨å¸ä»¥è¾¾åˆ°ç›®æ ‡é…ç½®`, "info");
                    }
                } else {
                    showNotification("æŠ•èµ„ç»„åˆå·²åœ¨å¹³è¡¡çŠ¶æ€", "info");
                }
            });
            
            document.getElementById('diversify-portfolio').addEventListener('click', () => {
                showNotification("å¤šå…ƒåŒ–æŠ•èµ„åŠŸèƒ½å°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­æä¾›", "info");
            });
            
            document.getElementById('export-portfolio').addEventListener('click', () => {
                showNotification("æŠ•èµ„ç»„åˆæ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
            });
            
            // äº¤æ˜“ç­–ç•¥åŠŸèƒ½
            document.getElementById('activate-strategy').addEventListener('click', activateStrategy);
            document.getElementById('backtest-strategy').addEventListener('click', backtestStrategy);
            document.getElementById('stop-strategy').addEventListener('click', stopStrategy);
            
            // æ–°é—»åŠŸèƒ½
            document.getElementById('generate-news').addEventListener('click', generateRandomNews);
            document.getElementById('clear-news').addEventListener('click', clearNews);
            document.getElementById('submit-custom-news').addEventListener('click', submitCustomNews);
            
            // è¡ç”Ÿå“åŠŸèƒ½
            document.getElementById('buy-futures').addEventListener('click', buyFutures);
            document.getElementById('sell-futures').addEventListener('click', sellFutures);
            document.getElementById('buy-options').addEventListener('click', buyOptions);
            document.getElementById('sell-options').addEventListener('click', sellOptions);
            document.getElementById('long-swap').addEventListener('click', longSwap);
            document.getElementById('short-swap').addEventListener('click', shortSwap);
            document.getElementById('hedge-portfolio').addEventListener('click', hedgePortfolio);
            document.getElementById('simulate-expiry').addEventListener('click', simulateExpiry);
            document.getElementById('liquidate-derivatives').addEventListener('click', liquidateDerivatives);
            
            // è‡ªåŠ¨æ³¢åŠ¨æ§åˆ¶
            document.getElementById('toggleAuto').addEventListener('click', toggleAutoFluctuation);
            document.getElementById('autoMode').addEventListener('change', function() {
                currentMode = this.value;
            });
            
            // ä¹°å–æŒ‰é’®
            document.getElementById('buy-btn').addEventListener('click', function() {
                const type = document.getElementById('buy-order-type').value;
                const amount = parseFloat(document.getElementById('buy-amount').value) || 0;
                
                if (type === 'market') {
                    if (executeTrade(amount, 'buy')) {
                        showNotification(`æˆåŠŸä¹°å…¥ ${amount.toFixed(2)} æ³¢åŠ¨å¸ï¼Œå•ä»· ${currentPrice.toFixed(2)} å…ƒ`, "success");
                    }
                } else {
                    const price = parseFloat(document.getElementById('buy-limit-price').value);
                    addOrderToBook('buy', amount, price, 'limit');
                }
            });
            
            document.getElementById('sell-btn').addEventListener('click', function() {
                const type = document.getElementById('sell-order-type').value;
                const amount = parseFloat(document.getElementById('sell-amount').value) || 0;
                
                if (type === 'market') {
                    if (executeTrade(amount, 'sell')) {
                        showNotification(`æˆåŠŸå–å‡º ${amount.toFixed(2)} æ³¢åŠ¨å¸ï¼Œå•ä»· ${currentPrice.toFixed(2)} å…ƒ`, "success");
                    }
                } else {
                    const price = parseFloat(document.getElementById('sell-limit-price').value);
                    addOrderToBook('sell', amount, price, 'limit');
                }
            });
            
            document.getElementById('buy-stop-limit').addEventListener('click', function() {
                const amount = parseFloat(document.getElementById('buy-amount').value) || 0;
                const stopPrice = currentPrice * 1.05;
                const limitPrice = currentPrice * 1.03;
                
                userOrders.push({
                    id: Date.now(),
                    side: 'buy',
                    amount: amount,
                    price: limitPrice,
                    stopPrice: stopPrice,
                    type: 'stop-limit',
                    timestamp: new Date()
                });
                
                showNotification(`ä¹°å…¥æ­¢æŸé™ä»·å•å·²è®¾ç½®: å½“ä»·æ ¼>=${stopPrice.toFixed(2)}æ—¶ä¹°å…¥ ${amount} å¸ @ ${limitPrice.toFixed(2)}`, "success");
            });
            
            document.getElementById('sell-stop-limit').addEventListener('click', function() {
                const amount = parseFloat(document.getElementById('sell-amount').value) || 0;
                const stopPrice = currentPrice * 0.95;
                const limitPrice = currentPrice * 0.97;
                
                userOrders.push({
                    id: Date.now(),
                    side: 'sell',
                    amount: amount,
                    price: limitPrice,
                    stopPrice: stopPrice,
                    type: 'stop-limit',
                    timestamp: new Date()
                });
                
                showNotification(`å–å‡ºæ­¢æŸé™ä»·å•å·²è®¾ç½®: å½“ä»·æ ¼<=${stopPrice.toFixed(2)}æ—¶å–å‡º ${amount} å¸ @ ${limitPrice.toFixed(2)}`, "success");
            });
            
            // æš—é»‘æ¨¡å¼åˆ‡æ¢
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        });
        
        // è·å–é‡ä»·å…³ç³»æè¿°
        function getVolumePriceRelation() {
            if (priceHistory.length < 2) return "æ•°æ®ä¸è¶³";
            
            const lastPrice = priceHistory[priceHistory.length - 1];
            const prevPrice = priceHistory[priceHistory.length - 2];
            const priceChange = (lastPrice - prevPrice) / prevPrice;
            
            if (priceChange > 0 && dailyVolume > totalSupply * currentPrice * 0.1) {
                return "é‡ä»·é½å‡ (å¥åº·ä¸Šæ¶¨)";
            } else if (priceChange > 0 && dailyVolume < totalSupply * currentPrice * 0.05) {
                return "æ— é‡ä¸Šæ¶¨ (è°¨æ…)";
            } else if (priceChange < 0 && dailyVolume > totalSupply * currentPrice * 0.1) {
                return "æ”¾é‡ä¸‹è·Œ (å¼±åŠ¿)";
            } else if (priceChange < 0 && dailyVolume < totalSupply * currentPrice * 0.05) {
                return "æ— é‡ä¸‹è·Œ (å¯èƒ½åå¼¹)";
            } else {
                return "é‡ä»·å…³ç³»ä¸­æ€§";
            }
        }
        
        // å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
        window.closeFuturesPosition = closeFuturesPosition;
        window.closeOptionsPosition = closeOptionsPosition;
        window.closeSwapPosition = closeSwapPosition;
    </script>
</body>
</html>